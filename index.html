<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2487">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; min-height: 14.0px}
  </style>
</head>
<body>
<p class="p1">&lt;!DOCTYPE html&gt;</p>
<p class="p1">&lt;html lang="en"&gt;</p>
<p class="p1">&lt;head&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;meta charset="UTF-8"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;title&gt;AI Swim Coach&lt;/title&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;script src="https://cdn.tailwindcss.com"&gt;&lt;/script&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"&gt;&lt;/script&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"&gt;&lt;/script&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;script src="https://cdn.jsdelivr.net/npm/chart.js"&gt;&lt;/script&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;style&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>body { font-family: 'Inter', sans-serif; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.nav-item { flex: 1; } /* Ensures even spacing */</p>
<p class="p1"><span class="Apple-converted-space">        </span>.nav-item.active svg, .nav-item.active .nav-text { color: #3b82f6; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>#loading-overlay, #log-session-modal, #weekly-review-modal { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); z-index: 9999; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.spinner { width: 56px; height: 56px; border: 8px solid #f3f3f3; border-top: 8px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.option-button { transition: all 0.2s ease-in-out; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.option-button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.option-button.selected { background-color: #3b82f6; color: white; border-color: #3b82f6; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.chat-bubble { max-width: 80%; padding: 10px 16px; border-radius: 20px; margin-bottom: 8px; word-wrap: break-word; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.chat-bubble.user { background-color: #3b82f6; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.chat-bubble.coach { background-color: #e5e7eb; color: #1f2937; align-self: flex-start; border-bottom-left-radius: 4px; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.loading-dots span { animation: blink 1.4s infinite both; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.loading-dots span:nth-child(2) { animation-delay: 0.2s; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.loading-dots span:nth-child(3) { animation-delay: 0.4s; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>@keyframes blink { 0%, 80%, 100% { opacity: 0; } 40% { opacity: 1; } }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.progress-bar-bg { background-color: #e5e7eb; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.progress-bar-fill { background-color: #3b82f6; transition: width 0.3s ease-in-out; }</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/style&gt;</p>
<p class="p1">&lt;/head&gt;</p>
<p class="p1">&lt;body class="bg-gray-100"&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="loading-overlay" class="flex-col justify-center items-center hidden"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div class="spinner"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;p id="loading-text" class="mt-4 text-lg text-gray-700"&gt;Loading...&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="log-session-modal" class="hidden items-center justify-center p-4"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm max-h-[90vh] overflow-y-auto"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;h2 class="text-xl font-bold mb-4"&gt;Log Your Session&lt;/h2&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div id="log-session-details"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="mt-4"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;label for="log-distance" class="block text-sm font-medium text-gray-700"&gt;Distance Swam (m)&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;input type="number" id="log-distance" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="mt-4"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;label for="log-time" class="block text-sm font-medium text-gray-700"&gt;Time (optional)&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;input type="text" id="log-time" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., 35:10"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="mt-4"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;label class="block text-sm font-medium text-gray-700"&gt;Effort (RPE 1-5)&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div id="log-effort-buttons" class="flex justify-around mt-2"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;button class="log-effort-btn p-3 rounded-full hover:bg-gray-200" data-effort="1"&gt;1&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;button class="log-effort-btn p-3 rounded-full hover:bg-gray-200" data-effort="2"&gt;2&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;button class="log-effort-btn p-3 rounded-full hover:bg-gray-200" data-effort="3"&gt;3&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;button class="log-effort-btn p-3 rounded-full hover:bg-gray-200" data-effort="4"&gt;4&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;button class="log-effort-btn p-3 rounded-full hover:bg-gray-200" data-effort="5"&gt;5&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="mt-4"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;label class="block text-sm font-medium text-gray-700"&gt;Technique&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div id="log-technique-buttons" class="flex justify-around mt-2"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;button class="log-technique-btn p-3 rounded-full hover:bg-gray-200" data-technique="Smooth"&gt;👍&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;button class="log-technique-btn p-3 rounded-full hover:bg-gray-200" data-technique="Okay"&gt;👌&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;button class="log-technique-btn p-3 rounded-full hover:bg-gray-200" data-technique="Sloppy"&gt;👎&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="mt-4"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;label for="log-notes" class="block text-sm font-medium text-gray-700"&gt;Notes&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;textarea id="log-notes" rows="3" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., 'Felt strong on the main set!'"&gt;&lt;/textarea&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="flex justify-between mt-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;button id="cancel-log-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full"&gt;Cancel&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;button id="save-log-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full"&gt;Save Log&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="weekly-review-modal" class="hidden items-center justify-center p-4"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;h2 class="text-xl font-bold mb-2"&gt;Weekly Review&lt;/h2&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div id="weekly-review-summary" class="text-sm text-gray-600 mb-4"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="mt-4"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;label class="block text-sm font-medium text-gray-700"&gt;How did last week's training load feel?&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div id="review-load-buttons" class="flex justify-around mt-2"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;button class="review-load-btn p-2 px-4 rounded-full hover:bg-gray-200" data-load="Too Easy"&gt;Too Easy&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;button class="review-load-btn p-2 px-4 rounded-full hover:bg-gray-200" data-load="Just Right"&gt;Just Right&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;button class="review-load-btn p-2 px-4 rounded-full hover:bg-gray-200" data-load="Too Hard"&gt;Too Hard&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="mt-4"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;label for="review-notes" class="block text-sm font-medium text-gray-700"&gt;Any notes or focus points for next week?&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;textarea id="review-notes" rows="3" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., 'My left shoulder felt tired'"&gt;&lt;/textarea&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="flex justify-between mt-6"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;button id="cancel-review-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full"&gt;Cancel&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;button id="submit-review-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full"&gt;Get New Plan&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="app-container" class="max-w-md mx-auto h-screen bg-white flex flex-col shadow-2xl hidden"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;main id="main-content" class="flex-grow p-6 overflow-y-auto"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div id="welcome-view" class="text-center flex-col justify-center items-center h-full hidden"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="mb-4"&gt;&lt;svg class="w-24 h-24 text-blue-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"&gt;&lt;path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10V3L4 14h7v7l9-11h-7z"&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;h1 class="text-3xl font-bold text-gray-800 mb-2"&gt;Welcome!&lt;/h1&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;p class="text-gray-600 mb-8"&gt;Let's create a personalized training plan to help you reach your goals.&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;button id="create-plan-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg"&gt;Create My Personal Plan&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div id="dashboard" class="tab-content hidden"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div id="plan" class="tab-content hidden"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div id="logbook" class="tab-content hidden"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div id="coach" class="tab-content hidden h-full flex flex-col"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div id="questionnaire-container" class="text-center h-full flex flex-col justify-start"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div id="coach-chat-container" class="hidden h-full flex flex-col"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                     </span>&lt;h2 class="text-xl font-bold text-center mb-4 text-gray-800"&gt;Chat with your Coach&lt;/h2&gt;</p>
<p class="p1"><span class="Apple-converted-space">                     </span>&lt;div id="chat-messages" class="flex-grow overflow-y-auto p-4 flex flex-col space-y-2 bg-gray-50 rounded-lg"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                     </span>&lt;div id="chat-input-container" class="mt-4 flex items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;input type="text" id="coach-chat-input" class="w-full border-gray-300 rounded-full py-2 px-4 focus:outline-none" placeholder="Ask a question or request a change..."&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;button id="coach-send-btn" class="ml-3 bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600"&gt;&lt;svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor"&gt;&lt;path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/main&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;footer id="nav-bar" class="w-full border-t border-gray-200 bg-gray-50 hidden"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;nav class="flex justify-around w-full h-16"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;a href="#" class="nav-item text-center text-gray-500 flex flex-col justify-center items-center" data-tab="dashboard"&gt;&lt;ion-icon name="speedometer-outline" class="text-2xl"&gt;&lt;/ion-icon&gt;&lt;span class="nav-text text-xs block"&gt;Dashboard&lt;/span&gt;&lt;/a&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;a href="#" class="nav-item text-center text-gray-500 flex flex-col justify-center items-center" data-tab="plan"&gt;&lt;ion-icon name="calendar-outline" class="text-2xl"&gt;&lt;/ion-icon&gt;&lt;span class="nav-text text-xs block"&gt;Plan&lt;/span&gt;&lt;/a&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;a href="#" class="nav-item text-center text-gray-500 flex flex-col justify-center items-center" data-tab="logbook"&gt;&lt;ion-icon name="bar-chart-outline" class="text-2xl"&gt;&lt;/ion-icon&gt;&lt;span class="nav-text text-xs block"&gt;Logbook&lt;/span&gt;&lt;/a&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;a href="#" class="nav-item text-center text-gray-500 flex flex-col justify-center items-center" data-tab="coach"&gt;&lt;ion-icon name="chatbubble-ellipses-outline" class="text-2xl"&gt;&lt;/ion-icon&gt;&lt;span class="nav-text text-xs block"&gt;AI Coach&lt;/span&gt;&lt;/a&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/nav&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/footer&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;script type="module"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>// --- State Management ---</p>
<p class="p1"><span class="Apple-converted-space">        </span>const appState = {</p>
<p class="p1"><span class="Apple-converted-space">            </span>activeTab: 'dashboard',</p>
<p class="p1"><span class="Apple-converted-space">            </span>currentView: 'loading', // loading, welcome, questionnaire, app</p>
<p class="p1"><span class="Apple-converted-space">            </span>plan: null,</p>
<p class="p1"><span class="Apple-converted-space">            </span>logs: [],</p>
<p class="p1"><span class="Apple-converted-space">            </span>coachChatHistory: [],</p>
<p class="p1"><span class="Apple-converted-space">            </span>weeklyChart: null,</p>
<p class="p1"><span class="Apple-converted-space">            </span>effortChart: null,</p>
<p class="p1"><span class="Apple-converted-space">            </span>techniqueChart: null,</p>
<p class="p1"><span class="Apple-converted-space">            </span>logbookViewPrefs: {</p>
<p class="p1"><span class="Apple-converted-space">                </span>showDistance: true,</p>
<p class="p1"><span class="Apple-converted-space">                </span>showEffort: true,</p>
<p class="p1"><span class="Apple-converted-space">                </span>showTechnique: true,</p>
<p class="p1"><span class="Apple-converted-space">                </span>showHistory: true</p>
<p class="p1"><span class="Apple-converted-space">            </span>},</p>
<p class="p1"><span class="Apple-converted-space">            </span>questionnaire: {</p>
<p class="p1"><span class="Apple-converted-space">                </span>currentStep: 0,</p>
<p class="p1"><span class="Apple-converted-space">                </span>answers: {},</p>
<p class="p1"><span class="Apple-converted-space">                </span>steps: [</p>
<p class="p1"><span class="Apple-converted-space">                    </span>{ key: 'goal', question: "What's your primary swimming goal?", options: ["Improve Endurance", "Improve Speed", "Improve General Fitness", "Train for a Competition", "Other"], type: 'single-select-other' },</p>
<p class="p1"><span class="Apple-converted-space">                    </span>{ key: 'level', question: "How would you describe your current swimming level?", options: ["Beginner", "Intermediate", "Advanced"] },</p>
<p class="p1"><span class="Apple-converted-space">                    </span>{ key: 'distance', question: "What's the furthest you can comfortably swim in one go?", options: ["&lt; 200m", "200m - 400m", "400m - 800m", "800m+"] },</p>
<p class="p1"><span class="Apple-converted-space">                    </span>{ key: 'equipment', question: "What equipment do you have access to?", options: ["Fins", "Pull Buoy", "Kickboard", "Paddles"], type: 'multi-select' },</p>
<p class="p1"><span class="Apple-converted-space">                    </span>{ key: 'strokes', question: "Which strokes do you want to focus on?", options: ["Freestyle", "Backstroke", "Breaststroke", "Butterfly"], type: 'multi-select' },</p>
<p class="p1"><span class="Apple-converted-space">                    </span>{ key: 'frequency', question: "How many days a week can you train?", options: ["1-2", "3-4", "5+"] },</p>
<p class="p1"><span class="Apple-converted-space">                    </span>{ key: 'notes', question: "Anything else your coach should know?", type: 'textarea' }</p>
<p class="p1"><span class="Apple-converted-space">                </span>]</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>};</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// --- DOM Elements ---</p>
<p class="p1"><span class="Apple-converted-space">        </span>const loadingOverlay = document.getElementById('loading-overlay');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const loadingText = document.getElementById('loading-text');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const appContainer = document.getElementById('app-container');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const welcomeView = document.getElementById('welcome-view');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const navBar = document.getElementById('nav-bar');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const createPlanBtn = document.getElementById('create-plan-btn');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const navItems = document.querySelectorAll('.nav-item');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const tabContents = document.querySelectorAll('.tab-content');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const planContainer = document.getElementById('plan');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const questionnaireContainer = document.getElementById('questionnaire-container');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const coachChatContainer = document.getElementById('coach-chat-container');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const dashboardContainer = document.getElementById('dashboard');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const logbookContainer = document.getElementById('logbook');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const chatMessages = document.getElementById('chat-messages');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const coachChatInput = document.getElementById('coach-chat-input');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const coachSendBtn = document.getElementById('coach-send-btn');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const logSessionModal = document.getElementById('log-session-modal');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const cancelLogBtn = document.getElementById('cancel-log-btn');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const saveLogBtn = document.getElementById('save-log-btn');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const weeklyReviewModal = document.getElementById('weekly-review-modal');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const cancelReviewBtn = document.getElementById('cancel-review-btn');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const submitReviewBtn = document.getElementById('submit-review-btn');</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// --- API Config ---</p>
<p class="p1"><span class="Apple-converted-space">        </span>const API_KEY = "";</p>
<p class="p1"><span class="Apple-converted-space">        </span>const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// --- Core Functions ---</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function render() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>loadingOverlay.classList.add('hidden');</p>
<p class="p1"><span class="Apple-converted-space">            </span>appContainer.classList.add('hidden');</p>
<p class="p1"><span class="Apple-converted-space">            </span>welcomeView.classList.add('hidden');</p>
<p class="p1"><span class="Apple-converted-space">            </span>navBar.classList.add('hidden');</p>
<p class="p1"><span class="Apple-converted-space">            </span>tabContents.forEach(content =&gt; content.classList.add('hidden'));</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>switch(appState.currentView) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>case 'loading':</p>
<p class="p1"><span class="Apple-converted-space">                    </span>appContainer.classList.add('hidden');</p>
<p class="p1"><span class="Apple-converted-space">                    </span>loadingOverlay.classList.remove('hidden');</p>
<p class="p1"><span class="Apple-converted-space">                    </span>loadingOverlay.classList.add('flex');</p>
<p class="p1"><span class="Apple-converted-space">                    </span>break;</p>
<p class="p1"><span class="Apple-converted-space">                </span>case 'welcome':</p>
<p class="p1"><span class="Apple-converted-space">                    </span>appContainer.classList.remove('hidden');</p>
<p class="p1"><span class="Apple-converted-space">                    </span>welcomeView.classList.remove('hidden');</p>
<p class="p1"><span class="Apple-converted-space">                    </span>welcomeView.classList.add('flex');</p>
<p class="p1"><span class="Apple-converted-space">                    </span>break;</p>
<p class="p1"><span class="Apple-converted-space">                </span>case 'questionnaire':</p>
<p class="p1"><span class="Apple-converted-space">                    </span>appContainer.classList.remove('hidden');</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const coachTab = document.getElementById('coach');</p>
<p class="p1"><span class="Apple-converted-space">                    </span>coachTab.classList.remove('hidden');</p>
<p class="p1"><span class="Apple-converted-space">                    </span>coachTab.classList.add('flex');</p>
<p class="p1"><span class="Apple-converted-space">                    </span>renderCoachTab();</p>
<p class="p1"><span class="Apple-converted-space">                    </span>break;</p>
<p class="p1"><span class="Apple-converted-space">                </span>case 'app':</p>
<p class="p1"><span class="Apple-converted-space">                    </span>appContainer.classList.remove('hidden');</p>
<p class="p1"><span class="Apple-converted-space">                    </span>navBar.classList.remove('hidden');</p>
<p class="p1"><span class="Apple-converted-space">                    </span>navBar.classList.add('flex');</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const activeContent = document.getElementById(appState.activeTab);</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (activeContent) {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>activeContent.classList.remove('hidden');</p>
<p class="p1"><span class="Apple-converted-space">                        </span>if (appState.activeTab === 'coach') {</p>
<p class="p1"><span class="Apple-converted-space">                            </span>activeContent.classList.add('flex');</p>
<p class="p1"><span class="Apple-converted-space">                            </span>renderCoachTab();</p>
<p class="p1"><span class="Apple-converted-space">                        </span>} else if (appState.activeTab === 'logbook') {</p>
<p class="p1"><span class="Apple-converted-space">                            </span>renderLogbook();</p>
<p class="p1"><span class="Apple-converted-space">                        </span>}</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p1"><span class="Apple-converted-space">                    </span>navItems.forEach(item =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>item.classList.toggle('active', item.dataset.tab === appState.activeTab);</p>
<p class="p1"><span class="Apple-converted-space">                    </span>});</p>
<p class="p1"><span class="Apple-converted-space">                    </span>break;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function renderCoachTab() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (appState.plan) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>questionnaireContainer.classList.add('hidden');</p>
<p class="p1"><span class="Apple-converted-space">                </span>coachChatContainer.classList.remove('hidden');</p>
<p class="p1"><span class="Apple-converted-space">                </span>coachChatContainer.classList.add('flex');</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                </span>coachChatContainer.classList.add('hidden');</p>
<p class="p1"><span class="Apple-converted-space">                </span>questionnaireContainer.classList.remove('hidden');</p>
<p class="p1"><span class="Apple-converted-space">                </span>questionnaireContainer.classList.add('flex');</p>
<p class="p1"><span class="Apple-converted-space">                </span>renderQuestionnaireStep();</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>function getVisibleSteps() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>return appState.questionnaire.steps.filter(step =&gt; !step.condition || step.condition(appState.questionnaire.answers));</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function renderQuestionnaireStep() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const visibleSteps = getVisibleSteps();</p>
<p class="p1"><span class="Apple-converted-space">            </span>const currentStepObject = appState.questionnaire.steps[appState.questionnaire.currentStep];</p>
<p class="p1"><span class="Apple-converted-space">            </span>const currentVisibleStepIndex = visibleSteps.indexOf(currentStepObject);</p>
<p class="p1"><span class="Apple-converted-space">            </span>const progress = currentVisibleStepIndex &gt;= 0 ? ((currentVisibleStepIndex) / visibleSteps.length) * 100 : 100;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>questionnaireContainer.innerHTML = `</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="w-full mb-8"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="flex justify-between mb-1"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;span class="text-base font-medium text-blue-700"&gt;Progress&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;span class="text-sm font-medium text-blue-700"&gt;${Math.round(progress)}%&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="w-full progress-bar-bg rounded-full h-2.5"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="progress-bar-fill h-2.5 rounded-full" style="width: ${progress}%"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>`;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const step = currentStepObject;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!step || currentVisibleStepIndex === -1) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>renderQuestionnaireSummary();</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const questionEl = document.createElement('h2');</p>
<p class="p1"><span class="Apple-converted-space">                </span>questionEl.className = 'text-2xl font-bold text-gray-800 mb-8';</p>
<p class="p1"><span class="Apple-converted-space">                </span>questionEl.textContent = step.question;</p>
<p class="p1"><span class="Apple-converted-space">                </span>questionnaireContainer.appendChild(questionEl);</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>const optionsContainer = document.createElement('div');</p>
<p class="p1"><span class="Apple-converted-space">                </span>optionsContainer.className = 'w-full';</p>
<p class="p1"><span class="Apple-converted-space">                </span>questionnaireContainer.appendChild(optionsContainer);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>switch (step.type) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>case 'textarea':</p>
<p class="p1"><span class="Apple-converted-space">                        </span>optionsContainer.innerHTML = `&lt;textarea id="freetext-notes" class="w-full h-32 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Optional..."&gt;${appState.questionnaire.answers.notes || ''}&lt;/textarea&gt;`;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>break;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>case 'number':</p>
<p class="p1"><span class="Apple-converted-space">                    </span>case 'date':</p>
<p class="p1"><span class="Apple-converted-space">                        </span>optionsContainer.innerHTML = `&lt;input type="${step.type}" id="input-${step.key}" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"&gt;`;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>break;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>case 'single-select-other':</p>
<p class="p1"><span class="Apple-converted-space">                        </span>const optionsGridSingle = document.createElement('div');</p>
<p class="p1"><span class="Apple-converted-space">                        </span>optionsGridSingle.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';</p>
<p class="p1"><span class="Apple-converted-space">                        </span>step.options.forEach(optionText =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                            </span>const optionBtn = document.createElement('button');</p>
<p class="p1"><span class="Apple-converted-space">                            </span>optionBtn.className = 'option-button bg-white border border-gray-300 text-gray-700 font-semibold py-4 px-4 rounded-lg shadow-sm';</p>
<p class="p1"><span class="Apple-converted-space">                            </span>optionBtn.textContent = optionText;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>optionBtn.addEventListener('click', () =&gt; optionText === "Other" ? renderOtherGoalInput() : handleOptionSelect(step.key, optionText));</p>
<p class="p1"><span class="Apple-converted-space">                            </span>optionsGridSingle.appendChild(optionBtn);</p>
<p class="p1"><span class="Apple-converted-space">                        </span>});</p>
<p class="p1"><span class="Apple-converted-space">                        </span>optionsContainer.appendChild(optionsGridSingle);</p>
<p class="p1"><span class="Apple-converted-space">                        </span>break;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>case 'multi-select':</p>
<p class="p1"><span class="Apple-converted-space">                        </span>appState.questionnaire.answers[step.key] = appState.questionnaire.answers[step.key] || [];</p>
<p class="p1"><span class="Apple-converted-space">                        </span>const optionsGridMulti = document.createElement('div');</p>
<p class="p1"><span class="Apple-converted-space">                        </span>optionsGridMulti.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';</p>
<p class="p1"><span class="Apple-converted-space">                        </span>step.options.forEach(optionText =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                            </span>const optionBtn = document.createElement('button');</p>
<p class="p1"><span class="Apple-converted-space">                            </span>optionBtn.className = 'option-button bg-white border border-gray-300 text-gray-700 font-semibold py-4 px-4 rounded-lg shadow-sm';</p>
<p class="p1"><span class="Apple-converted-space">                            </span>optionBtn.textContent = optionText;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>if (appState.questionnaire.answers[step.key].includes(optionText)) {</p>
<p class="p1"><span class="Apple-converted-space">                                </span>optionBtn.classList.add('selected');</p>
<p class="p1"><span class="Apple-converted-space">                            </span>}</p>
<p class="p1"><span class="Apple-converted-space">                            </span>optionBtn.addEventListener('click', () =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                                </span>optionBtn.classList.toggle('selected');</p>
<p class="p1"><span class="Apple-converted-space">                                </span>const selectedItems = appState.questionnaire.answers[step.key];</p>
<p class="p1"><span class="Apple-converted-space">                                </span>const index = selectedItems.indexOf(optionText);</p>
<p class="p1"><span class="Apple-converted-space">                                </span>if (optionBtn.classList.contains('selected') &amp;&amp; index === -1) {</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>selectedItems.push(optionText);</p>
<p class="p1"><span class="Apple-converted-space">                                </span>} else if (!optionBtn.classList.contains('selected') &amp;&amp; index &gt; -1) {</p>
<p class="p1"><span class="Apple-converted-space">                                    </span>selectedItems.splice(index, 1);</p>
<p class="p1"><span class="Apple-converted-space">                                </span>}</p>
<p class="p1"><span class="Apple-converted-space">                            </span>});</p>
<p class="p1"><span class="Apple-converted-space">                            </span>optionsGridMulti.appendChild(optionBtn);</p>
<p class="p1"><span class="Apple-converted-space">                        </span>});</p>
<p class="p1"><span class="Apple-converted-space">                        </span>optionsContainer.appendChild(optionsGridMulti);</p>
<p class="p1"><span class="Apple-converted-space">                        </span>break;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>default: // Standard single-select</p>
<p class="p1"><span class="Apple-converted-space">                        </span>const optionsGridDefault = document.createElement('div');</p>
<p class="p1"><span class="Apple-converted-space">                        </span>optionsGridDefault.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';</p>
<p class="p1"><span class="Apple-converted-space">                        </span>step.options.forEach(optionText =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                            </span>const optionBtn = document.createElement('button');</p>
<p class="p1"><span class="Apple-converted-space">                            </span>optionBtn.className = 'option-button bg-white border border-gray-300 text-gray-700 font-semibold py-4 px-4 rounded-lg shadow-sm';</p>
<p class="p1"><span class="Apple-converted-space">                            </span>optionBtn.textContent = optionText;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>optionBtn.addEventListener('click', () =&gt; handleOptionSelect(step.key, optionText));</p>
<p class="p1"><span class="Apple-converted-space">                            </span>optionsGridDefault.appendChild(optionBtn);</p>
<p class="p1"><span class="Apple-converted-space">                        </span>});</p>
<p class="p1"><span class="Apple-converted-space">                        </span>optionsContainer.appendChild(optionsGridDefault);</p>
<p class="p1"><span class="Apple-converted-space">                        </span>break;</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Navigation Buttons</p>
<p class="p1"><span class="Apple-converted-space">            </span>const navContainer = document.createElement('div');</p>
<p class="p1"><span class="Apple-converted-space">            </span>navContainer.className = 'flex justify-between w-full mt-8';</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const backBtn = document.createElement('button');</p>
<p class="p1"><span class="Apple-converted-space">            </span>backBtn.className = 'bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-full';</p>
<p class="p1"><span class="Apple-converted-space">            </span>backBtn.textContent = 'Back';</p>
<p class="p1"><span class="Apple-converted-space">            </span>backBtn.style.visibility = currentVisibleStepIndex &gt; 0 ? 'visible' : 'hidden';</p>
<p class="p1"><span class="Apple-converted-space">            </span>backBtn.addEventListener('click', handleQuestionnaireBack);</p>
<p class="p1"><span class="Apple-converted-space">            </span>navContainer.appendChild(backBtn);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (step &amp;&amp; (step.type === 'textarea' || step.type === 'multi-select' || step.type === 'number' || step.type === 'date')) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const continueBtn = document.createElement('button');</p>
<p class="p1"><span class="Apple-converted-space">                </span>continueBtn.className = 'bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full';</p>
<p class="p1"><span class="Apple-converted-space">                </span>continueBtn.textContent = 'Continue';</p>
<p class="p1"><span class="Apple-converted-space">                </span>continueBtn.addEventListener('click', () =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (step.type === 'textarea') {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>handleOptionSelect(step.key, document.getElementById('freetext-notes')?.value || 'None');</p>
<p class="p1"><span class="Apple-converted-space">                    </span>} else if (step.type === 'number' || step.type === 'date') {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>const value = document.getElementById(`input-${step.key}`).value;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>if (value) handleOptionSelect(step.key, value);</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p1"><span class="Apple-converted-space">                    </span>else {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>handleOptionSelect(step.key, appState.questionnaire.answers[step.key]);</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p1"><span class="Apple-converted-space">                </span>});</p>
<p class="p1"><span class="Apple-converted-space">                </span>navContainer.appendChild(continueBtn);</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>questionnaireContainer.appendChild(navContainer);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>function renderQuestionnaireSummary() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const { answers, steps } = appState.questionnaire;</p>
<p class="p1"><span class="Apple-converted-space">            </span>questionnaireContainer.innerHTML = `</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;h2 class="text-2xl font-bold text-gray-800 mb-4"&gt;Confirm Your Details&lt;/h2&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="bg-gray-50 p-4 rounded-lg"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;button id="summary-toggle" class="font-semibold text-blue-600 mb-2 w-full text-left flex justify-between items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;span&gt;View Summary&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;ion-icon name="chevron-down-outline"&gt;&lt;/ion-icon&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div id="summary-details" class="text-left space-y-3 hidden pt-2 border-t"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="mt-8"&gt;&lt;button id="generate-plan-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full shadow-lg"&gt;Generate My Plan&lt;/button&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>`;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const summaryDetails = document.getElementById('summary-details');</p>
<p class="p1"><span class="Apple-converted-space">            </span>getVisibleSteps().forEach(step =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const answer = answers[step.key];</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (answer &amp;&amp; answer.length &gt; 0) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const answerText = Array.isArray(answer) ? answer.join(', ') : answer;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>summaryDetails.innerHTML += `</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="flex justify-between items-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;p class="text-sm text-gray-500"&gt;${step.question}&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;p class="font-semibold text-gray-800"&gt;${answerText}&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;button class="edit-answer-btn text-blue-500 text-sm font-semibold" data-step-key="${step.key}"&gt;Edit&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('summary-toggle').addEventListener('click', (e) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>summaryDetails.classList.toggle('hidden');</p>
<p class="p1"><span class="Apple-converted-space">                </span>const buttonText = e.currentTarget.querySelector('span');</p>
<p class="p1"><span class="Apple-converted-space">                </span>const icon = e.currentTarget.querySelector('ion-icon');</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (summaryDetails.classList.contains('hidden')) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>buttonText.textContent = 'View Summary';</p>
<p class="p1"><span class="Apple-converted-space">                    </span>icon.name = 'chevron-down-outline';</p>
<p class="p1"><span class="Apple-converted-space">                </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>buttonText.textContent = 'Hide Summary';</p>
<p class="p1"><span class="Apple-converted-space">                    </span>icon.name = 'chevron-up-outline';</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('generate-plan-btn').addEventListener('click', handleGeneratePlan);</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.querySelectorAll('.edit-answer-btn').forEach(btn =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>btn.addEventListener('click', (e) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const stepKey = e.target.dataset.stepKey;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const stepIndex = steps.findIndex(s =&gt; s.key === stepKey);</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (stepIndex !== -1) {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>appState.questionnaire.currentStep = stepIndex;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>renderQuestionnaireStep();</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p1"><span class="Apple-converted-space">                </span>});</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function renderOtherGoalInput() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>questionnaireContainer.innerHTML = `</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;h2 class="text-2xl font-bold text-gray-800 mb-4"&gt;What is your specific goal?&lt;/h2&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;input type="text" id="other-goal-input" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., 'Complete a 1500m open water swim'"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="flex justify-between w-full mt-8"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;button id="other-goal-back" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-full"&gt;Back&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;button id="other-goal-submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full"&gt;Continue&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('other-goal-back').addEventListener('click', renderQuestionnaireStep);</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('other-goal-submit').addEventListener('click', () =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const goalText = document.getElementById('other-goal-input').value;</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (goalText) handleOptionSelect('goal', goalText);</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>async function handleGeneratePlan() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>appState.currentView = 'loading';</p>
<p class="p1"><span class="Apple-converted-space">            </span>loadingText.textContent = 'Building your personalized plan...';</p>
<p class="p1"><span class="Apple-converted-space">            </span>render();</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>const { answers } = appState.questionnaire;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const prompt = `You are an expert AI swimming coach. Create a 1-week swimming training plan based on these principles and user data:</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>**User Profile:**</p>
<p class="p1"><span class="Apple-converted-space">            </span>- Primary Goal: ${answers.goal} ${answers.goal === 'Train for a Competition' ? `(Distance: ${answers.competition_distance})` : ''}</p>
<p class="p1"><span class="Apple-converted-space">            </span>- Experience Level: ${answers.level}</p>
<p class="p1"><span class="Apple-converted-space">            </span>- Comfortable continuous swim distance: ${answers.distance}</p>
<p class="p1"><span class="Apple-converted-space">            </span>- Stroke focus: ${Array.isArray(answers.strokes) ? answers.strokes.join(', ') : 'any'}</p>
<p class="p1"><span class="Apple-converted-space">            </span>- Available Equipment: ${Array.isArray(answers.equipment) ? answers.equipment.join(', ') : 'none'}</p>
<p class="p1"><span class="Apple-converted-space">            </span>- Availability: ${answers.frequency} days a week</p>
<p class="p1"><span class="Apple-converted-space">            </span>- Other notes: ${answers.notes}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>**Training Principles:**</p>
<p class="p1"><span class="Apple-converted-space">            </span>1.<span class="Apple-converted-space">  </span>**Session Mix:** The weekly plan must include at least one technique/drill session. The rest should be a mix of endurance/aerobic, speed/anaerobic, and recovery sessions based on the user's goal.</p>
<p class="p1"><span class="Apple-converted-space">            </span>2.<span class="Apple-converted-space">  </span>**Speed Work:** Only include a speed/anaerobic session if the user's level is 'Intermediate' or 'Advanced'. For 'Beginner', focus on technique and endurance.</p>
<p class="p1"><span class="Apple-converted-space">            </span>3.<span class="Apple-converted-space">  </span>**Progressive Overload:** Ensure one session per week is a "push" session, slightly more challenging than the others.</p>
<p class="p1"><span class="Apple-converted-space">            </span>4.<span class="Apple-converted-space">  </span>**Safety:** The total distance for any single workout MUST NOT exceed the user's comfortable continuous swim distance.</p>
<p class="p1"><span class="Apple-converted-space">            </span>5.<span class="Apple-converted-space">  </span>**Structure:** Each session must have a Warm Up, Main Set, and Cool Down.</p>
<p class="p1"><span class="Apple-converted-space">            </span>6.<span class="Apple-converted-space">  </span>**No Timings/RPE:** Do NOT include rest timings (e.g., "on 1:30") or RPE targets in the workout details.</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>Your response MUST be a single, valid JSON object and nothing else, strictly adhering to this schema: { "weeklyPlan": [ { "day": "Monday", "title": "Session Title", "purpose": "Brief purpose of the workout", "focus": "Endurance|Speed|Technique|Recovery", "details": "Warm Up:\\n- ...\\nMain Set:\\n- ...\\nCool Down:\\n- ..." } ] }.`;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>try {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } };</p>
<p class="p1"><span class="Apple-converted-space">                </span>const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (!response.ok) throw new Error(`API Error: ${response.statusText}`);</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>const result = await response.json();</p>
<p class="p1"><span class="Apple-converted-space">                </span>const planData = JSON.parse(result.candidates[0].content.parts[0].text);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>if (planData.weeklyPlan) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>updatePlan(planData.weeklyPlan);</p>
<p class="p1"><span class="Apple-converted-space">                    </span>appState.activeTab = 'plan';</p>
<p class="p1"><span class="Apple-converted-space">                    </span>appState.currentView = 'app';</p>
<p class="p1"><span class="Apple-converted-space">                </span>} else { throw new Error("Invalid plan format received from AI."); }</p>
<p class="p1"><span class="Apple-converted-space">            </span>} catch (error) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>console.error("Error generating plan:", error);</p>
<p class="p1"><span class="Apple-converted-space">                </span>appState.currentView = 'welcome';</p>
<p class="p1"><span class="Apple-converted-space">                </span>alert("Sorry, we couldn't generate your plan right now. Please try again.");</p>
<p class="p1"><span class="Apple-converted-space">            </span>} finally {</p>
<p class="p1"><span class="Apple-converted-space">                </span>render();</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// --- Plan Processing &amp; Rendering ---</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>function calculateSessionDistance(details) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>let totalDistance = 0;</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (typeof details !== 'string') return 0;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const allDistances = details.match(/(\d+\s*x\s*\d+\s*m)|(\d+\s*m)/gi) || [];</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>allDistances.forEach(instance =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (instance.toLowerCase().includes('x')) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const parts = instance.toLowerCase().split('x');</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const reps = parseInt(parts[0], 10);</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const dist = parseInt(parts[1], 10);</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (!isNaN(reps) &amp;&amp; !isNaN(dist)) {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>totalDistance += reps * dist;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p1"><span class="Apple-converted-space">                </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const dist = parseInt(instance, 10);</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if (!isNaN(dist)) {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>totalDistance += dist;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p1"><span class="Apple-converted-space">            </span>return totalDistance;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function sortPlan(plan) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const dayOrder = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];</p>
<p class="p1"><span class="Apple-converted-space">            </span>return plan.sort((a, b) =&gt; dayOrder.indexOf(a.day) - dayOrder.indexOf(b.day));</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function processPlan(plan) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!Array.isArray(plan)) return [];</p>
<p class="p1"><span class="Apple-converted-space">            </span>const dayOrder = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];</p>
<p class="p1"><span class="Apple-converted-space">            </span>const fullWeekPlan = dayOrder.map(day =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const session = plan.find(s =&gt; s.day === day);</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (session) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>return { ...session, totalDistance: calculateSessionDistance(session.details) };</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">                </span>return { day: day, title: "Rest Day", purpose: "Recovery", details: "Take a day off to recover and rebuild.", totalDistance: 0 };</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p1"><span class="Apple-converted-space">            </span>return sortPlan(fullWeekPlan);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function renderDashboard() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>dashboardContainer.innerHTML = '';</p>
<p class="p1"><span class="Apple-converted-space">            </span>const today = new Date();</p>
<p class="p1"><span class="Apple-converted-space">            </span>const todayStr = today.toLocaleString('en-us', { weekday: 'long' });</p>
<p class="p1"><span class="Apple-converted-space">            </span>let todaysWorkout = appState.plan ? appState.plan.find(session =&gt; session.day === todayStr) : null;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const hasLoggedToday = appState.logs.some(log =&gt; new Date(log.date).toDateString() === today.toDateString());</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>dashboardContainer.innerHTML = `&lt;h1 class="text-2xl font-bold mb-4"&gt;Dashboard&lt;/h1&gt;`;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Weekly Progress Card</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (appState.plan) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const topRow = document.createElement('div');</p>
<p class="p1"><span class="Apple-converted-space">                </span>topRow.className = 'grid grid-cols-2 gap-4 mb-6';</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>const weekStart = new Date();</p>
<p class="p1"><span class="Apple-converted-space">                </span>weekStart.setDate(weekStart.getDate() - weekStart.getDay() + (weekStart.getDay() === 0 ? -6 : 1));</p>
<p class="p1"><span class="Apple-converted-space">                </span>weekStart.setHours(0,0,0,0);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>const logsThisWeek = appState.logs.filter(log =&gt; new Date(log.date) &gt;= weekStart);</p>
<p class="p1"><span class="Apple-converted-space">                </span>const completedCount = new Set(logsThisWeek.filter(l =&gt; l.type === 'swim').map(l =&gt; l.session.day)).size;</p>
<p class="p1"><span class="Apple-converted-space">                </span>const totalWorkouts = appState.plan.filter(s =&gt; s.title.toLowerCase() !== 'rest day').length;</p>
<p class="p1"><span class="Apple-converted-space">                </span>const progressPercent = totalWorkouts &gt; 0 ? (completedCount / totalWorkouts) * 100 : 0;</p>
<p class="p1"><span class="Apple-converted-space">                </span>const totalLoggedDistance = logsThisWeek.filter(l =&gt; l.type === 'swim').reduce((sum, l) =&gt; sum + l.distance, 0);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>topRow.innerHTML = `</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="bg-white p-4 rounded-lg shadow-md flex items-center justify-center"&gt;${createProgressRing(progressPercent, 'Workouts This Week', `${completedCount}/${totalWorkouts}`)}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="bg-white p-4 rounded-lg shadow-md flex items-center justify-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="text-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;p class="text-4xl font-bold"&gt;${totalLoggedDistance}&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;p class="text-sm text-gray-600 mt-2"&gt;Meters This Week&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>dashboardContainer.appendChild(topRow);</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>const card = document.createElement('div');</p>
<p class="p1"><span class="Apple-converted-space">            </span>card.className = 'session-card bg-white p-6 rounded-lg shadow-md border-l-4';</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (hasLoggedToday) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>card.classList.add('opacity-60');</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (todaysWorkout) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (todaysWorkout.title.toLowerCase() === 'rest day') {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>card.classList.add('border-gray-400');</p>
<p class="p1"><span class="Apple-converted-space">                    </span>card.innerHTML = `&lt;h2 class="text-xl font-bold text-gray-800"&gt;Rest Day!&lt;/h2&gt;&lt;p class="text-gray-600 mt-2"&gt;No workout scheduled for today. Tomorrow's focus: ${appState.plan[(appState.plan.indexOf(todaysWorkout) + 1) % 7].title}&lt;/p&gt;`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>card.classList.add('border-blue-500');</p>
<p class="p1"><span class="Apple-converted-space">                    </span>card.innerHTML = `</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="flex justify-between items-start"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;h2 class="text-xl font-bold text-gray-800 flex items-center"&gt;${todaysWorkout.title} ${hasLoggedToday ? '&lt;ion-icon name="checkmark-circle" class="text-green-500 ml-2"&gt;&lt;/ion-icon&gt;' : ''}&lt;/h2&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div id="dashboard-details" class="text-gray-600 mt-2 mb-4 hidden whitespace-pre-wrap"&gt;${todaysWorkout.details.replace(/\n/g, '&lt;br&gt;')}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;button id="toggle-details-btn" class="text-blue-500 font-semibold my-2"&gt;View Details&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;button id="log-session-btn" class="w-full mt-2 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg ${hasLoggedToday ? 'bg-gray-400 hover:bg-gray-400 cursor-not-allowed' : ''}" ${hasLoggedToday ? 'disabled' : ''}&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>${hasLoggedToday ? 'Completed' : 'Complete &amp; Log Session'}</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>`;</p>
<p class="p2"><span class="Apple-converted-space">                    </span></p>
<p class="p1"><span class="Apple-converted-space">                    </span>setTimeout(() =&gt; { // Use timeout to ensure card is in DOM</p>
<p class="p1"><span class="Apple-converted-space">                        </span>document.getElementById('toggle-details-btn').addEventListener('click', (e) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                            </span>const details = document.getElementById('dashboard-details');</p>
<p class="p1"><span class="Apple-converted-space">                            </span>details.classList.toggle('hidden');</p>
<p class="p1"><span class="Apple-converted-space">                            </span>e.target.textContent = details.classList.contains('hidden') ? 'View Details' : 'Hide Details';</p>
<p class="p1"><span class="Apple-converted-space">                        </span>});</p>
<p class="p1"><span class="Apple-converted-space">                        </span>if (!hasLoggedToday) {</p>
<p class="p1"><span class="Apple-converted-space">                            </span>document.getElementById('log-session-btn').addEventListener('click', () =&gt; openLogModal(todaysWorkout));</p>
<p class="p1"><span class="Apple-converted-space">                        </span>}</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}, 0);</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                 </span>card.classList.add('border-gray-400');</p>
<p class="p1"><span class="Apple-converted-space">                 </span>card.innerHTML = `&lt;h2 class="text-xl font-bold text-gray-800"&gt;No Workout Today&lt;/h2&gt;&lt;p class="text-gray-600 mt-2"&gt;Enjoy your day!&lt;/p&gt;`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>dashboardContainer.appendChild(card);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function createProgressRing(progressPercent, label, valueText) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const radius = 36;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const circumference = 2 * Math.PI * radius;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const offset = circumference - (progressPercent / 100) * circumference;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>return `</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div class="flex flex-col items-center justify-center text-center"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="relative w-24 h-24"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;svg class="w-full h-full transform -rotate-90"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;circle class="text-gray-200" stroke-width="8" stroke="currentColor" fill="transparent" r="${radius}" cx="50%" cy="50%"/&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;circle class="text-blue-500"</p>
<p class="p1"><span class="Apple-converted-space">                                </span>stroke-width="8"</p>
<p class="p1"><span class="Apple-converted-space">                                </span>stroke-dasharray="${circumference}"</p>
<p class="p1"><span class="Apple-converted-space">                                </span>stroke-dashoffset="${offset}"</p>
<p class="p1"><span class="Apple-converted-space">                                </span>stroke-linecap="round"</p>
<p class="p1"><span class="Apple-converted-space">                                </span>stroke="currentColor"</p>
<p class="p1"><span class="Apple-converted-space">                                </span>fill="transparent"</p>
<p class="p1"><span class="Apple-converted-space">                                </span>r="${radius}"</p>
<p class="p1"><span class="Apple-converted-space">                                </span>cx="50%"</p>
<p class="p1"><span class="Apple-converted-space">                                </span>cy="50%"/&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/svg&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;span class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-xl font-bold"&gt;${valueText}&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;span class="text-xs text-gray-500 mt-2 font-semibold"&gt;${label}&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>`;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function renderPlan(weeklyPlan) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>planContainer.innerHTML = `&lt;div class="flex justify-between items-center mb-4"&gt;&lt;h1 class="text-2xl font-bold"&gt;Your Weekly Plan&lt;/h1&gt;&lt;button id="adjust-plan-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full flex items-center"&gt;&lt;ion-icon name="create-outline" class="mr-2"&gt;&lt;/ion-icon&gt;Adjust Plan&lt;/button&gt;&lt;/div&gt;&lt;div id="plan-sessions" class="space-y-4"&gt;&lt;/div&gt;`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('adjust-plan-btn').addEventListener('click', () =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>appState.activeTab = 'coach';</p>
<p class="p1"><span class="Apple-converted-space">                </span>render();</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (appState.coachChatHistory.length === 0) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>addMessageToChat("How can I adjust your plan?", "coach");</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p1"><span class="Apple-converted-space">            </span>const planSessions = document.getElementById('plan-sessions');</p>
<p class="p1"><span class="Apple-converted-space">            </span>weeklyPlan.forEach(session =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const sessionCard = document.createElement('div');</p>
<p class="p1"><span class="Apple-converted-space">                </span>const hasLogged = appState.logs.some(log =&gt; log.type === 'swim' &amp;&amp; log.session.title === session.title &amp;&amp; log.session.day === session.day);</p>
<p class="p1"><span class="Apple-converted-space">                </span>const isRestDay = session.title.toLowerCase() === 'rest day';</p>
<p class="p1"><span class="Apple-converted-space">                </span>sessionCard.className = `bg-gray-100 p-4 rounded-lg shadow ${hasLogged || isRestDay ? 'opacity-60' : ''}`;</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>const formattedDetails = (session.details || '').replace(/Warm Up:|Main Set:|Cool Down:/gi, (match) =&gt; `&lt;strong&gt;${match}&lt;/strong&gt;`).replace(/\n/g, '&lt;br&gt;');</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>sessionCard.innerHTML = `</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div class="flex justify-between items-center cursor-pointer" data-target="details-${session.day}"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;h3 class="text-lg font-bold text-gray-800 flex items-center"&gt;${session.day} - ${session.title} ${hasLogged ? '&lt;ion-icon name="checkmark-circle" class="text-green-500 ml-2"&gt;&lt;/ion-icon&gt;' : ''}&lt;/h3&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;p class="text-sm text-gray-600 font-medium"&gt;${session.purpose || ''}&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;span class="text-2xl"&gt;${session.focus === 'Speed' ? '⚡️' : session.focus === 'Endurance' ? '🫁' : session.focus === 'Technique' ? '🧠' : '🧘'}&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;div id="details-${session.day}" class="mt-2 text-gray-600 hidden pt-2 border-t border-gray-200"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;p class="whitespace-pre-wrap"&gt;${formattedDetails}&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>${!isRestDay ? `&lt;p class="font-bold mt-2"&gt;Total Distance: ${session.totalDistance}m&lt;/p&gt;` : ''}</p>
<p class="p1"><span class="Apple-converted-space">                        </span>${!hasLogged &amp;&amp; !isRestDay ? `&lt;button class="mark-complete-btn mt-4 w-full bg-white hover:bg-gray-200 border border-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg" data-session='${JSON.stringify(session)}'&gt;Mark as Completed&lt;/button&gt;` : ''}</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>planSessions.appendChild(sessionCard);</p>
<p class="p1"><span class="Apple-converted-space">                </span>sessionCard.querySelector('[data-target]').addEventListener('click', (e) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const targetId = e.currentTarget.dataset.target;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>document.getElementById(targetId).classList.toggle('hidden');</p>
<p class="p1"><span class="Apple-converted-space">                </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>if (!hasLogged &amp;&amp; !isRestDay) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>sessionCard.querySelector('.mark-complete-btn').addEventListener('click', (e) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>e.stopPropagation();</p>
<p class="p1"><span class="Apple-converted-space">                        </span>openLogModal(JSON.parse(e.target.dataset.session));</p>
<p class="p1"><span class="Apple-converted-space">                    </span>});</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p1"><span class="Apple-converted-space">             </span>const nextWeekBtn = document.createElement('button');</p>
<p class="p1"><span class="Apple-converted-space">            </span>nextWeekBtn.id = 'plan-next-week-btn';</p>
<p class="p1"><span class="Apple-converted-space">            </span>nextWeekBtn.className = 'w-full mt-6 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow';</p>
<p class="p1"><span class="Apple-converted-space">            </span>nextWeekBtn.textContent = 'Plan Next Week';</p>
<p class="p1"><span class="Apple-converted-space">            </span>nextWeekBtn.addEventListener('click', handlePlanNextWeek);</p>
<p class="p1"><span class="Apple-converted-space">            </span>planContainer.appendChild(nextWeekBtn);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>function updatePlan(newPlan) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const processedPlan = processPlan(newPlan);</p>
<p class="p1"><span class="Apple-converted-space">            </span>appState.plan = processedPlan;</p>
<p class="p1"><span class="Apple-converted-space">            </span>savePlanToLocalStorage(processedPlan);</p>
<p class="p1"><span class="Apple-converted-space">            </span>renderPlan(processedPlan);</p>
<p class="p1"><span class="Apple-converted-space">            </span>renderDashboard();</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function addMessageToChat(text, sender) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const message = { text, sender };</p>
<p class="p1"><span class="Apple-converted-space">            </span>appState.coachChatHistory.push(message);</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const bubble = document.createElement('div');</p>
<p class="p1"><span class="Apple-converted-space">            </span>bubble.className = `chat-bubble ${sender}`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>bubble.textContent = text;</p>
<p class="p1"><span class="Apple-converted-space">            </span>chatMessages.appendChild(bubble);</p>
<p class="p1"><span class="Apple-converted-space">            </span>chatMessages.scrollTop = chatMessages.scrollHeight;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>async function handleCoachConversation(userRequest, isWeeklyReview = false, weeklyFeedback = {}) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!isWeeklyReview) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>addMessageToChat(userRequest, "user");</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>coachChatInput.value = '';</p>
<p class="p1"><span class="Apple-converted-space">            </span>coachChatInput.disabled = true;</p>
<p class="p1"><span class="Apple-converted-space">            </span>coachSendBtn.disabled = true;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>const typingBubble = document.createElement('div');</p>
<p class="p1"><span class="Apple-converted-space">            </span>typingBubble.id = 'typing-indicator';</p>
<p class="p1"><span class="Apple-converted-space">            </span>typingBubble.className = 'chat-bubble coach loading-dots';</p>
<p class="p1"><span class="Apple-converted-space">            </span>typingBubble.innerHTML = '&lt;span&gt;.&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;';</p>
<p class="p1"><span class="Apple-converted-space">            </span>chatMessages.appendChild(typingBubble);</p>
<p class="p1"><span class="Apple-converted-space">            </span>chatMessages.scrollTop = chatMessages.scrollHeight;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const logSummary = appState.logs.slice(-7).map(l =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (l.type === 'swim') {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>return `On ${new Date(l.date).toLocaleDateString()}, user logged '${l.session.title}' (${l.distance}m) and felt '${l.effort}' (RPE). Technique: ${l.technique}. Notes: ${l.notes}`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>return `On ${new Date(l.date).toLocaleDateString()}, user logged a non-swim activity: ${l.activity.type} for ${l.activity.duration} minutes. Notes: ${l.notes}`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>}).join('\n');</p>
<p class="p1"><span class="Apple-converted-space">            </span>const userProfile = JSON.stringify(appState.questionnaire.answers);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>const prompt = isWeeklyReview<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>? `The user wants to plan their next week. Based on their original profile, their previous week's plan, and their log history, generate a new, progressed 1-week plan and a brief report.</p>
<p class="p1"><span class="Apple-converted-space">                    </span>User Profile: ${userProfile}</p>
<p class="p1"><span class="Apple-converted-space">                    </span>Previous Week's Plan: ${JSON.stringify(appState.plan)}</p>
<p class="p1"><span class="Apple-converted-space">                    </span>Previous Week's Logs: \n${logSummary}\n</p>
<p class="p1"><span class="Apple-converted-space">                    </span>User's new feedback for the week: Overall load felt '${weeklyFeedback.load}'. Additional notes: '${weeklyFeedback.notes}'.</p>
<p class="p1"><span class="Apple-converted-space">                    </span>CRITICAL INSTRUCTION: Analyze all logs and feedback. If they reported sessions were 'Hard' or mentioned difficulties (like 'sore shoulder'), you MUST reduce the intensity or volume of the next week's plan, especially for workouts immediately following the difficult one. If they reported 'Easy' or 'Just Right', you should slightly increase the challenge.</p>
<p class="p1"><span class="Apple-converted-space">                    </span>Your response must be in the 'newPlan' field, and you must also provide a short 'answer' field summarizing their week and explaining the logic for the new plan.`</p>
<p class="p1"><span class="Apple-converted-space">                </span>: `A user is asking a question or requesting a plan adjustment.</p>
<p class="p1"><span class="Apple-converted-space">                    </span>Their current plan is: ${JSON.stringify(appState.plan)}</p>
<p class="p1"><span class="Apple-converted-space">                    </span>Their recent log history is: \n${logSummary}\n</p>
<p class="p1"><span class="Apple-converted-space">                    </span>Their user request is: "${userRequest}"</p>
<p class="p2"><span class="Apple-converted-space">                    </span></p>
<p class="p1"><span class="Apple-converted-space">                    </span>Analyze the user's request.<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                    </span>- If the user is asking to **change, modify, adjust, add, or remove** sessions, generate a new plan and respond in the 'newPlan' field. Also provide a brief confirmation in the 'answer' field.</p>
<p class="p1"><span class="Apple-converted-space">                    </span>- If the user is asking a **general question, for advice, or commenting on their performance**, provide a conversational answer in the 'answer' field and leave 'newPlan' as null.</p>
<p class="p1"><span class="Apple-converted-space">                </span>`;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const finalPrompt = `${prompt} Your response MUST be a single, valid JSON object and nothing else, strictly adhering to this schema: { "newPlan": [ { "day": "Monday", "title": "Session Title", "purpose": "Brief purpose...", "details": "..." } ] | null, "answer": "Your conversational response here." | null } Only populate 'newPlan' if a new plan is generated.`;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>try {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const payload = { contents: [{ role: "user", parts: [{ text: finalPrompt }] }], generationConfig: { responseMimeType: "application/json" } };</p>
<p class="p1"><span class="Apple-converted-space">                </span>const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (!response.ok) throw new Error(`API Error: ${response.statusText}`);</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>const result = await response.json();</p>
<p class="p1"><span class="Apple-converted-space">                </span>const coachResponse = JSON.parse(result.candidates[0].content.parts[0].text);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>if (coachResponse.newPlan) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>updatePlan(coachResponse.newPlan);</p>
<p class="p1"><span class="Apple-converted-space">                    </span>addMessageToChat(coachResponse.answer || "I've updated your plan. Take a look in the 'Plan' tab!", "coach");</p>
<p class="p1"><span class="Apple-converted-space">                </span>} else if (coachResponse.answer) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>addMessageToChat(coachResponse.answer, "coach");</p>
<p class="p1"><span class="Apple-converted-space">                </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>throw new Error("Invalid response format from AI.");</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>} catch(error) {</p>
<p class="p1"><span class="Apple-converted-space">                 </span>console.error("Error in coach conversation:", error);</p>
<p class="p1"><span class="Apple-converted-space">                 </span>addMessageToChat("Sorry, I had trouble understanding that. Could you try rephrasing?", "coach");</p>
<p class="p1"><span class="Apple-converted-space">            </span>} finally {</p>
<p class="p1"><span class="Apple-converted-space">                </span>document.getElementById('typing-indicator')?.remove();</p>
<p class="p1"><span class="Apple-converted-space">                </span>coachChatInput.disabled = false;</p>
<p class="p1"><span class="Apple-converted-space">                </span>coachSendBtn.disabled = false;</p>
<p class="p1"><span class="Apple-converted-space">                </span>coachChatInput.focus();</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>function openLogModal(session) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>logSessionModal.dataset.session = JSON.stringify(session);</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('log-session-details').innerHTML = `&lt;p class="text-sm text-gray-600"&gt;Logging for: &lt;strong&gt;${session.title}&lt;/strong&gt;&lt;/p&gt;`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('log-distance').value = session.totalDistance;</p>
<p class="p1"><span class="Apple-converted-space">            </span>logSessionModal.classList.remove('hidden');</p>
<p class="p1"><span class="Apple-converted-space">            </span>logSessionModal.classList.add('flex');</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function closeLogModal() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>logSessionModal.classList.add('hidden');</p>
<p class="p1"><span class="Apple-converted-space">            </span>logSessionModal.classList.remove('flex');</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('log-notes').value = '';</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.querySelectorAll('.log-effort-btn.selected, .log-technique-btn.selected').forEach(b =&gt; b.classList.remove('selected', 'bg-blue-200'));</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>function handleSaveLog() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const session = JSON.parse(logSessionModal.dataset.session);</p>
<p class="p1"><span class="Apple-converted-space">            </span>const distance = parseInt(document.getElementById('log-distance').value, 10);</p>
<p class="p1"><span class="Apple-converted-space">            </span>const time = document.getElementById('log-time').value;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const effort = document.querySelector('.log-effort-btn.selected')?.dataset.effort || 'Not specified';</p>
<p class="p1"><span class="Apple-converted-space">            </span>const technique = document.querySelector('.log-technique-btn.selected')?.dataset.technique || 'Not specified';</p>
<p class="p1"><span class="Apple-converted-space">            </span>const notes = document.getElementById('log-notes').value;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const logEntry = {</p>
<p class="p1"><span class="Apple-converted-space">                </span>type: 'swim',</p>
<p class="p1"><span class="Apple-converted-space">                </span>date: new Date().toISOString(),</p>
<p class="p1"><span class="Apple-converted-space">                </span>session: session,</p>
<p class="p1"><span class="Apple-converted-space">                </span>distance: isNaN(distance) ? session.totalDistance : distance,</p>
<p class="p1"><span class="Apple-converted-space">                </span>time: time,</p>
<p class="p1"><span class="Apple-converted-space">                </span>effort: effort,</p>
<p class="p1"><span class="Apple-converted-space">                </span>technique: technique,</p>
<p class="p1"><span class="Apple-converted-space">                </span>notes: notes</p>
<p class="p1"><span class="Apple-converted-space">            </span>};</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>appState.logs.push(logEntry);</p>
<p class="p1"><span class="Apple-converted-space">            </span>saveLogsToLocalStorage();</p>
<p class="p1"><span class="Apple-converted-space">            </span>renderLogbook();</p>
<p class="p1"><span class="Apple-converted-space">            </span>renderDashboard(); // Re-render dashboard to show logged state</p>
<p class="p1"><span class="Apple-converted-space">            </span>renderPlan(appState.plan); // Re-render plan to show completed state</p>
<p class="p1"><span class="Apple-converted-space">            </span>closeLogModal();</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>function renderLogbook() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>logbookContainer.innerHTML = `&lt;div class="flex justify-between items-center mb-4"&gt;&lt;h1 class="text-2xl font-bold"&gt;Logbook&lt;/h1&gt;&lt;button id="edit-view-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full flex items-center"&gt;&lt;ion-icon name="options-outline" class="mr-2"&gt;&lt;/ion-icon&gt;Edit View&lt;/button&gt;&lt;/div&gt;`;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const viewOptions = document.createElement('div');</p>
<p class="p1"><span class="Apple-converted-space">            </span>viewOptions.id = 'view-options';</p>
<p class="p1"><span class="Apple-converted-space">            </span>viewOptions.className = 'hidden bg-gray-50 p-4 rounded-lg mb-4 space-y-2';</p>
<p class="p1"><span class="Apple-converted-space">            </span>viewOptions.innerHTML = `</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;label class="flex items-center"&gt;&lt;input type="checkbox" data-view="showDistance" class="mr-2" ${appState.logbookViewPrefs.showDistance ? 'checked' : ''}&gt; Weekly Distance Chart&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;label class="flex items-center"&gt;&lt;input type="checkbox" data-view="showEffort" class="mr-2" ${appState.logbookViewPrefs.showEffort ? 'checked' : ''}&gt; Effort (RPE) Chart&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;label class="flex items-center"&gt;&lt;input type="checkbox" data-view="showTechnique" class="mr-2" ${appState.logbookViewPrefs.showTechnique ? 'checked' : ''}&gt; Technique Chart&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;label class="flex items-center"&gt;&lt;input type="checkbox" data-view="showHistory" class="mr-2" ${appState.logbookViewPrefs.showHistory ? 'checked' : ''}&gt; Detailed History&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>logbookContainer.appendChild(viewOptions);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('edit-view-btn').addEventListener('click', () =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>viewOptions.classList.toggle('hidden');</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>viewOptions.querySelectorAll('input[type="checkbox"]').forEach(checkbox =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>checkbox.addEventListener('change', (e) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>appState.logbookViewPrefs[e.target.dataset.view] = e.target.checked;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>saveLogbookViewPrefs();</p>
<p class="p1"><span class="Apple-converted-space">                    </span>renderLogbook();</p>
<p class="p1"><span class="Apple-converted-space">                </span>});</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>const chartGrid = document.createElement('div');</p>
<p class="p1"><span class="Apple-converted-space">            </span>chartGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 mb-6';</p>
<p class="p1"><span class="Apple-converted-space">            </span>chartGrid.innerHTML = `</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div id="distance-chart-container" class="${appState.logbookViewPrefs.showDistance ? '' : 'hidden'}"&gt;&lt;canvas id="logbook-chart"&gt;&lt;/canvas&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div id="effort-chart-container" class="${appState.logbookViewPrefs.showEffort ? '' : 'hidden'}"&gt;&lt;canvas id="effort-chart"&gt;&lt;/canvas&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;div id="technique-chart-container" class="${appState.logbookViewPrefs.showTechnique ? '' : 'hidden'}"&gt;&lt;canvas id="technique-chart"&gt;&lt;/canvas&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>logbookContainer.appendChild(chartGrid);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>const historyContainer = document.createElement('div');</p>
<p class="p1"><span class="Apple-converted-space">            </span>historyContainer.id = 'history-container';</p>
<p class="p1"><span class="Apple-converted-space">            </span>historyContainer.className = `${appState.logbookViewPrefs.showHistory ? '' : 'hidden'}`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>historyContainer.innerHTML = `&lt;button id="history-toggle" class="font-semibold text-blue-600 mb-2 w-full text-left flex justify-between items-center"&gt;&lt;span&gt;Detailed History&lt;/span&gt;&lt;ion-icon name="chevron-down-outline"&gt;&lt;/ion-icon&gt;&lt;/button&gt;&lt;div id="log-list" class="space-y-4 hidden pt-2 border-t"&gt;&lt;/div&gt;`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>logbookContainer.appendChild(historyContainer);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('history-toggle').addEventListener('click', (e) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const logList = document.getElementById('log-list');</p>
<p class="p1"><span class="Apple-converted-space">                </span>logList.classList.toggle('hidden');</p>
<p class="p1"><span class="Apple-converted-space">                </span>const icon = e.currentTarget.querySelector('ion-icon');</p>
<p class="p1"><span class="Apple-converted-space">                </span>icon.name = logList.classList.contains('hidden') ? 'chevron-down-outline' : 'chevron-up-outline';</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (appState.logs.length === 0) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>logbookContainer.innerHTML += `&lt;p class="text-gray-600"&gt;Your completed sessions will appear here.&lt;/p&gt;`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>renderWeeklyChart([]);</p>
<p class="p1"><span class="Apple-converted-space">                </span>renderEffortChart([]);</p>
<p class="p1"><span class="Apple-converted-space">                </span>renderTechniqueChart([]);</p>
<p class="p1"><span class="Apple-converted-space">                </span>return;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const swimLogs = appState.logs.filter(l =&gt; l.type === 'swim');</p>
<p class="p1"><span class="Apple-converted-space">            </span>const weeklyData = swimLogs.reduce((acc, log) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const date = new Date(log.date);</p>
<p class="p1"><span class="Apple-converted-space">                </span>const weekStart = new Date(date.setDate(date.getDate() - date.getDay() + (date.getDay() === 0 ? -6 : 1)));</p>
<p class="p1"><span class="Apple-converted-space">                </span>const weekKey = weekStart.toLocaleDateString('en-CA');</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (!acc[weekKey]) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>acc[weekKey] = 0;</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">                </span>acc[weekKey] += log.distance;</p>
<p class="p1"><span class="Apple-converted-space">                </span>return acc;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}, {});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>const chartData = Object.entries(weeklyData).map(([date, distance]) =&gt; ({ date, distance })).sort((a,b) =&gt; new Date(a.date) - new Date(b.date));</p>
<p class="p1"><span class="Apple-converted-space">            </span>renderWeeklyChart(chartData);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>const effortData = swimLogs.reduce((acc, log) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>acc[log.effort] = (acc[log.effort] || 0) + 1;</p>
<p class="p1"><span class="Apple-converted-space">                </span>return acc;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}, {});</p>
<p class="p1"><span class="Apple-converted-space">            </span>renderEffortChart(effortData);</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const techniqueData = swimLogs.reduce((acc, log) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>acc[log.technique] = (acc[log.technique] || 0) + 1;</p>
<p class="p1"><span class="Apple-converted-space">                </span>return acc;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}, {});</p>
<p class="p1"><span class="Apple-converted-space">            </span>renderTechniqueChart(techniqueData);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>const logListEl = document.getElementById('log-list');</p>
<p class="p1"><span class="Apple-converted-space">            </span>[...appState.logs].reverse().forEach(log =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const logCard = document.createElement('div');</p>
<p class="p1"><span class="Apple-converted-space">                </span>logCard.className = 'bg-gray-50 p-4 rounded-lg cursor-pointer';</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>if(log.type === 'swim') {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const formattedDetails = (log.session.details || '').replace(/Warm Up:|Main Set:|Cool Down:/gi, (match) =&gt; `&lt;br&gt;&lt;strong&gt;${match}&lt;/strong&gt;`).replace(/\n/g, '&lt;br&gt;');</p>
<p class="p1"><span class="Apple-converted-space">                    </span>logCard.innerHTML = `</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="flex justify-between items-start"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;p class="font-bold"&gt;${new Date(log.date).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;p class="text-sm text-gray-700 mt-1"&gt;&lt;strong&gt;Workout:&lt;/strong&gt; ${log.session.title}&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;p class="text-sm text-gray-700"&gt;&lt;strong&gt;Effort (RPE):&lt;/strong&gt; ${log.effort}&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                                </span>&lt;p class="text-sm text-gray-700"&gt;&lt;strong&gt;Technique:&lt;/strong&gt; ${log.technique}&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;div class="text-sm font-semibold text-blue-600"&gt;${log.distance}m&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;div class="log-details mt-2 text-gray-600 hidden pt-2 border-t border-gray-200"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>&lt;p class="whitespace-pre-wrap"&gt;${formattedDetails}&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">                            </span>${log.notes ? `&lt;p class="text-sm text-gray-700 mt-2 p-2 bg-white rounded"&gt;&lt;strong&gt;Notes:&lt;/strong&gt; ${log.notes}&lt;/p&gt;` : ''}</p>
<p class="p1"><span class="Apple-converted-space">                        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>logCard.addEventListener('click', () =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>logCard.querySelector('.log-details').classList.toggle('hidden');</p>
<p class="p1"><span class="Apple-converted-space">                </span>});</p>
<p class="p1"><span class="Apple-converted-space">                </span>logListEl.appendChild(logCard);</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function renderWeeklyChart(data) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const container = document.getElementById('distance-chart-container');</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!container || container.classList.contains('hidden')) return;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const ctx = document.getElementById('logbook-chart').getContext('2d');</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (appState.weeklyChart) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>appState.weeklyChart.destroy();</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>appState.weeklyChart = new Chart(ctx, {</p>
<p class="p1"><span class="Apple-converted-space">                </span>type: 'bar',</p>
<p class="p1"><span class="Apple-converted-space">                </span>data: {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>labels: data.map(d =&gt; `Week of ${new Date(d.date).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}`),</p>
<p class="p1"><span class="Apple-converted-space">                    </span>datasets: [{</p>
<p class="p1"><span class="Apple-converted-space">                        </span>label: 'Total Distance (m)',</p>
<p class="p1"><span class="Apple-converted-space">                        </span>data: data.map(d =&gt; d.distance),</p>
<p class="p1"><span class="Apple-converted-space">                        </span>backgroundColor: 'rgba(59, 130, 246, 0.5)',</p>
<p class="p1"><span class="Apple-converted-space">                        </span>borderColor: 'rgba(59, 130, 246, 1)',</p>
<p class="p1"><span class="Apple-converted-space">                        </span>borderWidth: 1</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}]</p>
<p class="p1"><span class="Apple-converted-space">                </span>},</p>
<p class="p1"><span class="Apple-converted-space">                </span>options: {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>scales: { y: { beginAtZero: true } },</p>
<p class="p1"><span class="Apple-converted-space">                    </span>plugins: { legend: { display: false }, title: { display: true, text: 'Weekly Distance' } }</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>function renderEffortChart(data) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const container = document.getElementById('effort-chart-container');</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!container || container.classList.contains('hidden')) return;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const ctx = document.getElementById('effort-chart').getContext('2d');</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (appState.effortChart) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>appState.effortChart.destroy();</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>appState.effortChart = new Chart(ctx, {</p>
<p class="p1"><span class="Apple-converted-space">                </span>type: 'bar',</p>
<p class="p1"><span class="Apple-converted-space">                </span>data: {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>labels: ['1', '2', '3', '4', '5'],</p>
<p class="p1"><span class="Apple-converted-space">                    </span>datasets: [{</p>
<p class="p1"><span class="Apple-converted-space">                        </span>label: 'Effort (RPE)',</p>
<p class="p1"><span class="Apple-converted-space">                        </span>data: [data['1'] || 0, data['2'] || 0, data['3'] || 0, data['4'] || 0, data['5'] || 0],</p>
<p class="p1"><span class="Apple-converted-space">                        </span>backgroundColor: 'rgba(255, 159, 64, 0.5)',</p>
<p class="p1"><span class="Apple-converted-space">                        </span>borderColor: 'rgba(255, 159, 64, 1)',</p>
<p class="p1"><span class="Apple-converted-space">                        </span>borderWidth: 1</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}]</p>
<p class="p1"><span class="Apple-converted-space">                </span>},</p>
<p class="p1"><span class="Apple-converted-space">                 </span>options: {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },</p>
<p class="p1"><span class="Apple-converted-space">                    </span>plugins: { legend: { display: false }, title: { display: true, text: 'Effort (RPE)' } }</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function renderTechniqueChart(data) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const container = document.getElementById('technique-chart-container');</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!container || container.classList.contains('hidden')) return;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const ctx = document.getElementById('technique-chart').getContext('2d');</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (appState.techniqueChart) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>appState.techniqueChart.destroy();</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>appState.techniqueChart = new Chart(ctx, {</p>
<p class="p1"><span class="Apple-converted-space">                </span>type: 'bar',</p>
<p class="p1"><span class="Apple-converted-space">                </span>data: {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>labels: ['Smooth', 'Okay', 'Sloppy'],</p>
<p class="p1"><span class="Apple-converted-space">                    </span>datasets: [{</p>
<p class="p1"><span class="Apple-converted-space">                        </span>label: 'Technique',</p>
<p class="p1"><span class="Apple-converted-space">                        </span>data: [data['Smooth'] || 0, data['Okay'] || 0, data['Sloppy'] || 0],</p>
<p class="p1"><span class="Apple-converted-space">                        </span>backgroundColor: ['rgba(75, 192, 192, 0.5)', 'rgba(255, 205, 86, 0.5)', 'rgba(255, 99, 132, 0.5)'],</p>
<p class="p1"><span class="Apple-converted-space">                        </span>borderColor: ['rgba(75, 192, 192, 1)', 'rgba(255, 205, 86, 1)', 'rgba(255, 99, 132, 1)'],</p>
<p class="p1"><span class="Apple-converted-space">                        </span>borderWidth: 1</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}]</p>
<p class="p1"><span class="Apple-converted-space">                </span>},</p>
<p class="p1"><span class="Apple-converted-space">                 </span>options: {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },</p>
<p class="p1"><span class="Apple-converted-space">                    </span>plugins: { legend: { display: false }, title: { display: true, text: 'Technique' } }</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// --- Local Storage &amp; Event Handlers ---</p>
<p class="p1"><span class="Apple-converted-space">        </span>function savePlanToLocalStorage(plan) { try { localStorage.setItem('swimCoachPlan', JSON.stringify(plan)); } catch (e) { console.error(e); } }</p>
<p class="p1"><span class="Apple-converted-space">        </span>function loadPlanFromLocalStorage() { try { return JSON.parse(localStorage.getItem('swimCoachPlan')); } catch (e) { return null; } }</p>
<p class="p1"><span class="Apple-converted-space">        </span>function saveLogsToLocalStorage() { try { localStorage.setItem('swimCoachLogs', JSON.stringify(appState.logs)); } catch (e) { console.error(e); } }</p>
<p class="p1"><span class="Apple-converted-space">        </span>function loadLogsFromLocalStorage() { try { return JSON.parse(localStorage.getItem('swimCoachLogs')) || []; } catch (e) { return []; } }</p>
<p class="p1"><span class="Apple-converted-space">        </span>function saveLogbookViewPrefs() { try { localStorage.setItem('swimCoachLogbookViewPrefs', JSON.stringify(appState.logbookViewPrefs)); } catch (e) { console.error(e); } }</p>
<p class="p1"><span class="Apple-converted-space">        </span>function loadLogbookViewPrefs() { try { return JSON.parse(localStorage.getItem('swimCoachLogbookViewPrefs')) || appState.logbookViewPrefs; } catch (e) { return appState.logbookViewPrefs; } }</p>
<p class="p1"><span class="Apple-converted-space">        </span>function handleNavClick(e) { e.preventDefault(); appState.activeTab = e.currentTarget.dataset.tab; render(); }</p>
<p class="p1"><span class="Apple-converted-space">        </span>function handleCreatePlanClick() { appState.currentView = 'questionnaire'; render(); }</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>function handleOptionSelect(key, value) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>appState.questionnaire.answers[key] = value;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>const visibleSteps = getVisibleSteps();</p>
<p class="p1"><span class="Apple-converted-space">            </span>const currentStepObject = appState.questionnaire.steps.find(s =&gt; s.key === key);</p>
<p class="p1"><span class="Apple-converted-space">            </span>let currentVisibleStepIndex = visibleSteps.indexOf(currentStepObject);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (currentVisibleStepIndex &lt; visibleSteps.length - 1) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const nextVisibleStep = visibleSteps[currentVisibleStepIndex + 1];</p>
<p class="p1"><span class="Apple-converted-space">                </span>appState.questionnaire.currentStep = appState.questionnaire.steps.indexOf(nextVisibleStep);</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                </span>appState.questionnaire.currentStep = appState.questionnaire.steps.length;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>renderQuestionnaireStep();</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function handleQuestionnaireBack() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const visibleSteps = getVisibleSteps();</p>
<p class="p1"><span class="Apple-converted-space">            </span>const currentStepObject = appState.questionnaire.steps[appState.questionnaire.currentStep] || visibleSteps[visibleSteps.length - 1];</p>
<p class="p1"><span class="Apple-converted-space">            </span>let currentVisibleStepIndex = visibleSteps.indexOf(currentStepObject);</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (currentVisibleStepIndex === -1) { // We are at the 'Generate Plan' or summary screen</p>
<p class="p1"><span class="Apple-converted-space">                </span>currentVisibleStepIndex = visibleSteps.length;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (currentVisibleStepIndex &gt; 0) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const prevVisibleStep = visibleSteps[currentVisibleStepIndex - 1];</p>
<p class="p1"><span class="Apple-converted-space">                </span>appState.questionnaire.currentStep = appState.questionnaire.steps.indexOf(prevVisibleStep);</p>
<p class="p1"><span class="Apple-converted-space">                </span>renderQuestionnaireStep();</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>function handleSendCoachMessage() { const message = coachChatInput.value.trim(); if (message) handleCoachConversation(message, false); }</p>
<p class="p1"><span class="Apple-converted-space">        </span>function handlePlanNextWeek() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>openWeeklyReviewModal();</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function openWeeklyReviewModal() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const today = new Date();</p>
<p class="p1"><span class="Apple-converted-space">            </span>const weekStart = new Date(today);</p>
<p class="p1"><span class="Apple-converted-space">            </span>weekStart.setDate(weekStart.getDate() - weekStart.getDay() + (weekStart.getDay() === 0 ? -6 : 1));</p>
<p class="p1"><span class="Apple-converted-space">            </span>weekStart.setHours(0,0,0,0);</p>
<p class="p1"><span class="Apple-converted-space">            </span>const logsThisWeek = appState.logs.filter(log =&gt; new Date(log.date) &gt;= weekStart);</p>
<p class="p1"><span class="Apple-converted-space">            </span>const summaryEl = document.getElementById('weekly-review-summary');</p>
<p class="p1"><span class="Apple-converted-space">            </span>summaryEl.innerHTML = `This past week, you completed &lt;strong&gt;${logsThisWeek.length}&lt;/strong&gt; workouts. Let's plan the next one!`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>weeklyReviewModal.classList.remove('hidden');</p>
<p class="p1"><span class="Apple-converted-space">            </span>weeklyReviewModal.classList.add('flex');</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function closeWeeklyReviewModal() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>weeklyReviewModal.classList.add('hidden');</p>
<p class="p1"><span class="Apple-converted-space">            </span>weeklyReviewModal.classList.remove('flex');</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.getElementById('review-notes').value = '';</p>
<p class="p1"><span class="Apple-converted-space">            </span>document.querySelectorAll('.review-load-btn.selected').forEach(b =&gt; b.classList.remove('selected', 'bg-blue-200'));</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function handleWeeklyReviewSubmit() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const load = document.querySelector('.review-load-btn.selected')?.dataset.load || 'Not specified';</p>
<p class="p1"><span class="Apple-converted-space">            </span>const notes = document.getElementById('review-notes').value;</p>
<p class="p1"><span class="Apple-converted-space">            </span>closeWeeklyReviewModal();</p>
<p class="p1"><span class="Apple-converted-space">            </span>appState.activeTab = 'coach';</p>
<p class="p1"><span class="Apple-converted-space">            </span>render();</p>
<p class="p1"><span class="Apple-converted-space">            </span>addMessageToChat(`Weekly Review:\nLoad: ${load}\nNotes: ${notes}`, "user");</p>
<p class="p1"><span class="Apple-converted-space">            </span>handleCoachConversation("Plan my next week based on my review.", true, { load, notes });</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// --- App Initialization ---</p>
<p class="p1"><span class="Apple-converted-space">        </span>function initializeApp() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>appState.plan = loadPlanFromLocalStorage();</p>
<p class="p1"><span class="Apple-converted-space">            </span>appState.logs = loadLogsFromLocalStorage();</p>
<p class="p1"><span class="Apple-converted-space">            </span>appState.logbookViewPrefs = loadLogbookViewPrefs();</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (appState.plan) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>updatePlan(appState.plan);<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>renderLogbook();</p>
<p class="p1"><span class="Apple-converted-space">                </span>appState.currentView = 'app';</p>
<p class="p1"><span class="Apple-converted-space">                </span>appState.activeTab = 'dashboard';</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                </span>appState.currentView = 'welcome';</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>render();</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>createPlanBtn.addEventListener('click', handleCreatePlanClick);</p>
<p class="p1"><span class="Apple-converted-space">        </span>navItems.forEach(item =&gt; item.addEventListener('click', handleNavClick));</p>
<p class="p1"><span class="Apple-converted-space">        </span>coachSendBtn.addEventListener('click', handleSendCoachMessage);</p>
<p class="p1"><span class="Apple-converted-space">        </span>coachChatInput.addEventListener('keypress', (e) =&gt; { if (e.key === 'Enter') handleSendCoachMessage(); });</p>
<p class="p1"><span class="Apple-converted-space">        </span>cancelLogBtn.addEventListener('click', closeLogModal);</p>
<p class="p1"><span class="Apple-converted-space">        </span>saveLogBtn.addEventListener('click', handleSaveLog);</p>
<p class="p1"><span class="Apple-converted-space">        </span>cancelReviewBtn.addEventListener('click', closeWeeklyReviewModal);</p>
<p class="p1"><span class="Apple-converted-space">        </span>submitReviewBtn.addEventListener('click', handleWeeklyReviewSubmit);</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>logSessionModal.addEventListener('click', (e) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (e.target.classList.contains('log-effort-btn')) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>document.querySelectorAll('.log-effort-btn').forEach(b =&gt; b.classList.remove('selected', 'bg-blue-200'));</p>
<p class="p1"><span class="Apple-converted-space">                </span>e.target.classList.add('selected', 'bg-blue-200');</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (e.target.classList.contains('log-technique-btn')) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>document.querySelectorAll('.log-technique-btn').forEach(b =&gt; b.classList.remove('selected', 'bg-blue-200'));</p>
<p class="p1"><span class="Apple-converted-space">                </span>e.target.classList.add('selected', 'bg-blue-200');</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>weeklyReviewModal.addEventListener('click', (e) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">             </span>if (e.target.classList.contains('review-load-btn')) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>document.querySelectorAll('.review-load-btn').forEach(b =&gt; b.classList.remove('selected', 'bg-blue-200'));</p>
<p class="p1"><span class="Apple-converted-space">                </span>e.target.classList.add('selected', 'bg-blue-200');</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>});</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>initializeApp();</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/script&gt;</p>
<p class="p1">&lt;/body&gt;</p>
<p class="p1">&lt;/html&gt;</p>
</body>
</html>
