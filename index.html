<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Swim Coach</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .nav-item { flex: 1; } /* Ensures even spacing */
        .nav-item.active svg, .nav-item.active .nav-text { color: #3b82f6; }
        #loading-overlay, #log-session-modal, #weekly-review-modal { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); z-index: 9999; }
        .spinner { width: 56px; height: 56px; border: 8px solid #f3f3f3; border-top: 8px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .option-button { transition: all 0.2s ease-in-out; }
        .option-button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .option-button.selected { background-color: #3b82f6; color: white; border-color: #3b82f6; }
        .chat-bubble { max-width: 80%; padding: 10px 16px; border-radius: 20px; margin-bottom: 8px; word-wrap: break-word; }
        .chat-bubble.user { background-color: #3b82f6; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .chat-bubble.coach { background-color: #e5e7eb; color: #1f2937; align-self: flex-start; border-bottom-left-radius: 4px; }
        .loading-dots span { animation: blink 1.4s infinite both; }
        .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
        .loading-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0%, 80%, 100% { opacity: 0; } 40% { opacity: 1; } }
        .progress-bar-bg { background-color: #e5e7eb; }
        .progress-bar-fill { background-color: #3b82f6; transition: width 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="loading-overlay" class="flex-col justify-center items-center hidden">
        <div class="spinner"></div>
        <p id="loading-text" class="mt-4 text-lg text-gray-700">Loading...</p>
    </div>
    
    <div id="log-session-modal" class="hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold mb-4">Log Your Session</h2>
            <div id="log-session-details"></div>
            <div class="mt-4">
                <label for="log-distance" class="block text-sm font-medium text-gray-700">Distance Swam (m)</label>
                <input type="number" id="log-distance" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="mt-4">
                <label for="log-time" class="block text-sm font-medium text-gray-700">Time (optional)</label>
                <input type="text" id="log-time" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., 35:10">
            </div>
            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700">Effort (RPE 1-5)</label>
                <div id="log-effort-buttons" class="flex justify-around mt-2">
                    <button class="log-effort-btn p-3 rounded-full hover:bg-gray-200" data-effort="1">1</button>
                    <button class="log-effort-btn p-3 rounded-full hover:bg-gray-200" data-effort="2">2</button>
                    <button class="log-effort-btn p-3 rounded-full hover:bg-gray-200" data-effort="3">3</button>
                    <button class="log-effort-btn p-3 rounded-full hover:bg-gray-200" data-effort="4">4</button>
                    <button class="log-effort-btn p-3 rounded-full hover:bg-gray-200" data-effort="5">5</button>
                </div>
            </div>
            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700">Technique</label>
                <div id="log-technique-buttons" class="flex justify-around mt-2">
                    <button class="log-technique-btn p-3 rounded-full hover:bg-gray-200" data-technique="Smooth">üëç</button>
                    <button class="log-technique-btn p-3 rounded-full hover:bg-gray-200" data-technique="Okay">üëå</button>
                    <button class="log-technique-btn p-3 rounded-full hover:bg-gray-200" data-technique="Sloppy">üëé</button>
                </div>
            </div>
            <div class="mt-4">
                <label for="log-notes" class="block text-sm font-medium text-gray-700">Notes</label>
                <textarea id="log-notes" rows="3" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., 'Felt strong on the main set!'"></textarea>
            </div>
            <div class="flex justify-between mt-6">
                <button id="cancel-log-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full">Cancel</button>
                <button id="save-log-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full">Save Log</button>
            </div>
        </div>
    </div>
    
    <div id="weekly-review-modal" class="hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h2 class="text-xl font-bold mb-2">Weekly Review</h2>
            <div id="weekly-review-summary" class="text-sm text-gray-600 mb-4"></div>
            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700">How did last week's training load feel?</label>
                <div id="review-load-buttons" class="flex justify-around mt-2">
                    <button class="review-load-btn p-2 px-4 rounded-full hover:bg-gray-200" data-load="Too Easy">Too Easy</button>
                    <button class="review-load-btn p-2 px-4 rounded-full hover:bg-gray-200" data-load="Just Right">Just Right</button>
                    <button class="review-load-btn p-2 px-4 rounded-full hover:bg-gray-200" data-load="Too Hard">Too Hard</button>
                </div>
            </div>
            <div class="mt-4">
                <label for="review-notes" class="block text-sm font-medium text-gray-700">Any notes or focus points for next week?</label>
                <textarea id="review-notes" rows="3" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., 'My left shoulder felt tired'"></textarea>
            </div>
            <div class="flex justify-between mt-6">
                <button id="cancel-review-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full">Cancel</button>
                <button id="submit-review-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full">Get New Plan</button>
            </div>
        </div>
    </div>

    <div id="app-container" class="max-w-md mx-auto h-screen bg-white flex flex-col shadow-2xl hidden">
        <main id="main-content" class="flex-grow p-6 overflow-y-auto">
            <div id="welcome-view" class="text-center flex-col justify-center items-center h-full hidden">
                <div class="mb-4"><svg class="w-24 h-24 text-blue-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg></div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Welcome!</h1>
                <p class="text-gray-600 mb-8">Let's create a personalized training plan to help you reach your goals.</p>
                <button id="create-plan-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg">Create My Personal Plan</button>
            </div>
            <div id="dashboard" class="tab-content hidden"></div>
            <div id="plan" class="tab-content hidden"></div>
            <div id="logbook" class="tab-content hidden"></div>
            <div id="coach" class="tab-content hidden h-full flex flex-col">
                <div id="questionnaire-container" class="text-center h-full flex flex-col justify-start"></div>
                <div id="coach-chat-container" class="hidden h-full flex flex-col">
                     <h2 class="text-xl font-bold text-center mb-4 text-gray-800">Chat with your Coach</h2>
                     <div id="chat-messages" class="flex-grow overflow-y-auto p-4 flex flex-col space-y-2 bg-gray-50 rounded-lg"></div>
                     <div id="chat-input-container" class="mt-4 flex items-center">
                        <input type="text" id="coach-chat-input" class="w-full border-gray-300 rounded-full py-2 px-4 focus:outline-none" placeholder="Ask a question or request a change...">
                        <button id="coach-send-btn" class="ml-3 bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg></button>
                    </div>
                </div>
            </div>
        </main>
        <footer id="nav-bar" class="w-full border-t border-gray-200 bg-gray-50 hidden">
            <nav class="flex justify-around w-full h-16">
                <a href="#" class="nav-item text-center text-gray-500 flex flex-col justify-center items-center" data-tab="dashboard"><ion-icon name="speedometer-outline" class="text-2xl"></ion-icon><span class="nav-text text-xs block">Dashboard</span></a>
                <a href="#" class="nav-item text-center text-gray-500 flex flex-col justify-center items-center" data-tab="plan"><ion-icon name="calendar-outline" class="text-2xl"></ion-icon><span class="nav-text text-xs block">Plan</span></a>
                <a href="#" class="nav-item text-center text-gray-500 flex flex-col justify-center items-center" data-tab="logbook"><ion-icon name="bar-chart-outline" class="text-2xl"></ion-icon><span class="nav-text text-xs block">Logbook</span></a>
                <a href="#" class="nav-item text-center text-gray-500 flex flex-col justify-center items-center" data-tab="coach"><ion-icon name="chatbubble-ellipses-outline" class="text-2xl"></ion-icon><span class="nav-text text-xs block">AI Coach</span></a>
            </nav>
        </footer>
    </div>

    <script type="module">
        // --- State Management ---
        const appState = {
            activeTab: 'dashboard',
            currentView: 'loading', // loading, welcome, questionnaire, app
            plan: null,
            logs: [],
            coachChatHistory: [],
            weeklyChart: null,
            effortChart: null,
            techniqueChart: null,
            logbookViewPrefs: {
                showDistance: true,
                showEffort: true,
                showTechnique: true,
                showHistory: true
            },
            questionnaire: {
                currentStep: 0,
                answers: {},
                steps: [
                    { key: 'goal', question: "What's your primary swimming goal?", options: ["Improve Endurance", "Improve Speed", "Improve General Fitness", "Train for a Competition", "Other"], type: 'single-select-other' },
                    { key: 'level', question: "How would you describe your current swimming level?", options: ["Beginner", "Intermediate", "Advanced"] },
                    { key: 'distance', question: "What's the furthest you can comfortably swim in one go?", options: ["< 200m", "200m - 400m", "400m - 800m", "800m+"] },
                    { key: 'equipment', question: "What equipment do you have access to?", options: ["Fins", "Pull Buoy", "Kickboard", "Paddles"], type: 'multi-select' },
                    { key: 'strokes', question: "Which strokes do you want to focus on?", options: ["Freestyle", "Backstroke", "Breaststroke", "Butterfly"], type: 'multi-select' },
                    { key: 'frequency', question: "How many days a week can you train?", options: ["1-2", "3-4", "5+"] },
                    { key: 'notes', question: "Anything else your coach should know?", type: 'textarea' }
                ]
            }
        };

        // --- DOM Elements ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const appContainer = document.getElementById('app-container');
        const welcomeView = document.getElementById('welcome-view');
        const navBar = document.getElementById('nav-bar');
        const createPlanBtn = document.getElementById('create-plan-btn');
        const navItems = document.querySelectorAll('.nav-item');
        const tabContents = document.querySelectorAll('.tab-content');
        const planContainer = document.getElementById('plan');
        const questionnaireContainer = document.getElementById('questionnaire-container');
        const coachChatContainer = document.getElementById('coach-chat-container');
        const dashboardContainer = document.getElementById('dashboard');
        const logbookContainer = document.getElementById('logbook');
        const chatMessages = document.getElementById('chat-messages');
        const coachChatInput = document.getElementById('coach-chat-input');
        const coachSendBtn = document.getElementById('coach-send-btn');
        const logSessionModal = document.getElementById('log-session-modal');
        const cancelLogBtn = document.getElementById('cancel-log-btn');
        const saveLogBtn = document.getElementById('save-log-btn');
        const weeklyReviewModal = document.getElementById('weekly-review-modal');
        const cancelReviewBtn = document.getElementById('cancel-review-btn');
        const submitReviewBtn = document.getElementById('submit-review-btn');

        // --- API Config ---
        const API_KEY = "";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;
        
        // --- Core Functions ---

        function render() {
            loadingOverlay.classList.add('hidden');
            appContainer.classList.add('hidden');
            welcomeView.classList.add('hidden');
            navBar.classList.add('hidden');
            tabContents.forEach(content => content.classList.add('hidden'));

            switch(appState.currentView) {
                case 'loading':
                    appContainer.classList.add('hidden');
                    loadingOverlay.classList.remove('hidden');
                    loadingOverlay.classList.add('flex');
                    break;
                case 'welcome':
                    appContainer.classList.remove('hidden');
                    welcomeView.classList.remove('hidden');
                    welcomeView.classList.add('flex');
                    break;
                case 'questionnaire':
                    appContainer.classList.remove('hidden');
                    const coachTab = document.getElementById('coach');
                    coachTab.classList.remove('hidden');
                    coachTab.classList.add('flex');
                    renderCoachTab();
                    break;
                case 'app':
                    appContainer.classList.remove('hidden');
                    navBar.classList.remove('hidden');
                    navBar.classList.add('flex');
                    const activeContent = document.getElementById(appState.activeTab);
                    if (activeContent) {
                        activeContent.classList.remove('hidden');
                        if (appState.activeTab === 'coach') {
                            activeContent.classList.add('flex');
                            renderCoachTab();
                        } else if (appState.activeTab === 'logbook') {
                            renderLogbook();
                        }
                    }
                    navItems.forEach(item => {
                        item.classList.toggle('active', item.dataset.tab === appState.activeTab);
                    });
                    break;
            }
        }

        function renderCoachTab() {
            if (appState.plan) {
                questionnaireContainer.classList.add('hidden');
                coachChatContainer.classList.remove('hidden');
                coachChatContainer.classList.add('flex');
            } else {
                coachChatContainer.classList.add('hidden');
                questionnaireContainer.classList.remove('hidden');
                questionnaireContainer.classList.add('flex');
                renderQuestionnaireStep();
            }
        }
        
        function getVisibleSteps() {
            return appState.questionnaire.steps.filter(step => !step.condition || step.condition(appState.questionnaire.answers));
        }

        function renderQuestionnaireStep() {
            const visibleSteps = getVisibleSteps();
            const currentStepObject = appState.questionnaire.steps[appState.questionnaire.currentStep];
            const currentVisibleStepIndex = visibleSteps.indexOf(currentStepObject);
            const progress = currentVisibleStepIndex >= 0 ? ((currentVisibleStepIndex) / visibleSteps.length) * 100 : 100;
            
            questionnaireContainer.innerHTML = `
                <div class="w-full mb-8">
                    <div class="flex justify-between mb-1">
                        <span class="text-base font-medium text-blue-700">Progress</span>
                        <span class="text-sm font-medium text-blue-700">${Math.round(progress)}%</span>
                    </div>
                    <div class="w-full progress-bar-bg rounded-full h-2.5">
                        <div class="progress-bar-fill h-2.5 rounded-full" style="width: ${progress}%"></div>
                    </div>
                </div>
            `;
            
            const step = currentStepObject;

            if (!step || currentVisibleStepIndex === -1) {
                renderQuestionnaireSummary();
            } else {
                const questionEl = document.createElement('h2');
                questionEl.className = 'text-2xl font-bold text-gray-800 mb-8';
                questionEl.textContent = step.question;
                questionnaireContainer.appendChild(questionEl);
                
                const optionsContainer = document.createElement('div');
                optionsContainer.className = 'w-full';
                questionnaireContainer.appendChild(optionsContainer);

                switch (step.type) {
                    case 'textarea':
                        optionsContainer.innerHTML = `<textarea id="freetext-notes" class="w-full h-32 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Optional...">${appState.questionnaire.answers.notes || ''}</textarea>`;
                        break;
                    case 'number':
                    case 'date':
                        optionsContainer.innerHTML = `<input type="${step.type}" id="input-${step.key}" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">`;
                        break;
                    case 'single-select-other':
                        const optionsGridSingle = document.createElement('div');
                        optionsGridSingle.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
                        step.options.forEach(optionText => {
                            const optionBtn = document.createElement('button');
                            optionBtn.className = 'option-button bg-white border border-gray-300 text-gray-700 font-semibold py-4 px-4 rounded-lg shadow-sm';
                            optionBtn.textContent = optionText;
                            optionBtn.addEventListener('click', () => optionText === "Other" ? renderOtherGoalInput() : handleOptionSelect(step.key, optionText));
                            optionsGridSingle.appendChild(optionBtn);
                        });
                        optionsContainer.appendChild(optionsGridSingle);
                        break;
                    case 'multi-select':
                        appState.questionnaire.answers[step.key] = appState.questionnaire.answers[step.key] || [];
                        const optionsGridMulti = document.createElement('div');
                        optionsGridMulti.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
                        step.options.forEach(optionText => {
                            const optionBtn = document.createElement('button');
                            optionBtn.className = 'option-button bg-white border border-gray-300 text-gray-700 font-semibold py-4 px-4 rounded-lg shadow-sm';
                            optionBtn.textContent = optionText;
                            if (appState.questionnaire.answers[step.key].includes(optionText)) {
                                optionBtn.classList.add('selected');
                            }
                            optionBtn.addEventListener('click', () => {
                                optionBtn.classList.toggle('selected');
                                const selectedItems = appState.questionnaire.answers[step.key];
                                const index = selectedItems.indexOf(optionText);
                                if (optionBtn.classList.contains('selected') && index === -1) {
                                    selectedItems.push(optionText);
                                } else if (!optionBtn.classList.contains('selected') && index > -1) {
                                    selectedItems.splice(index, 1);
                                }
                            });
                            optionsGridMulti.appendChild(optionBtn);
                        });
                        optionsContainer.appendChild(optionsGridMulti);
                        break;
                    default: // Standard single-select
                        const optionsGridDefault = document.createElement('div');
                        optionsGridDefault.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
                        step.options.forEach(optionText => {
                            const optionBtn = document.createElement('button');
                            optionBtn.className = 'option-button bg-white border border-gray-300 text-gray-700 font-semibold py-4 px-4 rounded-lg shadow-sm';
                            optionBtn.textContent = optionText;
                            optionBtn.addEventListener('click', () => handleOptionSelect(step.key, optionText));
                            optionsGridDefault.appendChild(optionBtn);
                        });
                        optionsContainer.appendChild(optionsGridDefault);
                        break;
                }
            }

            // Navigation Buttons
            const navContainer = document.createElement('div');
            navContainer.className = 'flex justify-between w-full mt-8';
            
            const backBtn = document.createElement('button');
            backBtn.className = 'bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-full';
            backBtn.textContent = 'Back';
            backBtn.style.visibility = currentVisibleStepIndex > 0 ? 'visible' : 'hidden';
            backBtn.addEventListener('click', handleQuestionnaireBack);
            navContainer.appendChild(backBtn);

            if (step && (step.type === 'textarea' || step.type === 'multi-select' || step.type === 'number' || step.type === 'date')) {
                const continueBtn = document.createElement('button');
                continueBtn.className = 'bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full';
                continueBtn.textContent = 'Continue';
                continueBtn.addEventListener('click', () => {
                    if (step.type === 'textarea') {
                        handleOptionSelect(step.key, document.getElementById('freetext-notes')?.value || 'None');
                    } else if (step.type === 'number' || step.type === 'date') {
                        const value = document.getElementById(`input-${step.key}`).value;
                        if (value) handleOptionSelect(step.key, value);
                    }
                    else {
                        handleOptionSelect(step.key, appState.questionnaire.answers[step.key]);
                    }
                });
                navContainer.appendChild(continueBtn);
            }

            questionnaireContainer.appendChild(navContainer);
        }
        
        function renderQuestionnaireSummary() {
            const { answers, steps } = appState.questionnaire;
            questionnaireContainer.innerHTML = `
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Confirm Your Details</h2>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <button id="summary-toggle" class="font-semibold text-blue-600 mb-2 w-full text-left flex justify-between items-center">
                        <span>View Summary</span>
                        <ion-icon name="chevron-down-outline"></ion-icon>
                    </button>
                    <div id="summary-details" class="text-left space-y-3 hidden pt-2 border-t"></div>
                </div>
                <div class="mt-8"><button id="generate-plan-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full shadow-lg">Generate My Plan</button></div>
            `;
            
            const summaryDetails = document.getElementById('summary-details');
            getVisibleSteps().forEach(step => {
                const answer = answers[step.key];
                if (answer && answer.length > 0) {
                    const answerText = Array.isArray(answer) ? answer.join(', ') : answer;
                    summaryDetails.innerHTML += `
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm text-gray-500">${step.question}</p>
                                <p class="font-semibold text-gray-800">${answerText}</p>
                            </div>
                            <button class="edit-answer-btn text-blue-500 text-sm font-semibold" data-step-key="${step.key}">Edit</button>
                        </div>
                    `;
                }
            });

            document.getElementById('summary-toggle').addEventListener('click', (e) => {
                summaryDetails.classList.toggle('hidden');
                const buttonText = e.currentTarget.querySelector('span');
                const icon = e.currentTarget.querySelector('ion-icon');
                if (summaryDetails.classList.contains('hidden')) {
                    buttonText.textContent = 'View Summary';
                    icon.name = 'chevron-down-outline';
                } else {
                    buttonText.textContent = 'Hide Summary';
                    icon.name = 'chevron-up-outline';
                }
            });
            
            document.getElementById('generate-plan-btn').addEventListener('click', handleGeneratePlan);
            document.querySelectorAll('.edit-answer-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const stepKey = e.target.dataset.stepKey;
                    const stepIndex = steps.findIndex(s => s.key === stepKey);
                    if (stepIndex !== -1) {
                        appState.questionnaire.currentStep = stepIndex;
                        renderQuestionnaireStep();
                    }
                });
            });
        }

        function renderOtherGoalInput() {
            questionnaireContainer.innerHTML = `
                <h2 class="text-2xl font-bold text-gray-800 mb-4">What is your specific goal?</h2>
                <input type="text" id="other-goal-input" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., 'Complete a 1500m open water swim'">
                <div class="flex justify-between w-full mt-8">
                    <button id="other-goal-back" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-full">Back</button>
                    <button id="other-goal-submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full">Continue</button>
                </div>
            `;
            document.getElementById('other-goal-back').addEventListener('click', renderQuestionnaireStep);
            document.getElementById('other-goal-submit').addEventListener('click', () => {
                const goalText = document.getElementById('other-goal-input').value;
                if (goalText) handleOptionSelect('goal', goalText);
            });
        }

        async function handleGeneratePlan() {
            appState.currentView = 'loading';
            loadingText.textContent = 'Building your personalized plan...';
            render();

            const { answers } = appState.questionnaire;
            const prompt = `You are an expert AI swimming coach. Create a 1-week swimming training plan based on these principles and user data:
            
            **User Profile:**
            - Primary Goal: ${answers.goal} ${answers.goal === 'Train for a Competition' ? `(Distance: ${answers.competition_distance})` : ''}
            - Experience Level: ${answers.level}
            - Comfortable continuous swim distance: ${answers.distance}
            - Stroke focus: ${Array.isArray(answers.strokes) ? answers.strokes.join(', ') : 'any'}
            - Available Equipment: ${Array.isArray(answers.equipment) ? answers.equipment.join(', ') : 'none'}
            - Availability: ${answers.frequency} days a week
            - Other notes: ${answers.notes}

            **Training Principles:**
            1.  **Session Mix:** The weekly plan must include at least one technique/drill session. The rest should be a mix of endurance/aerobic, speed/anaerobic, and recovery sessions based on the user's goal.
            2.  **Speed Work:** Only include a speed/anaerobic session if the user's level is 'Intermediate' or 'Advanced'. For 'Beginner', focus on technique and endurance.
            3.  **Progressive Overload:** Ensure one session per week is a "push" session, slightly more challenging than the others.
            4.  **Safety:** The total distance for any single workout MUST NOT exceed the user's comfortable continuous swim distance.
            5.  **Structure:** Each session must have a Warm Up, Main Set, and Cool Down.
            6.  **No Timings/RPE:** Do NOT include rest timings (e.g., "on 1:30") or RPE targets in the workout details.
            7.  **Math:** For each section (Warm Up, Main Set, Cool Down), calculate and display the subtotal distance. Then, calculate and display the final "Total Distance" for the entire session. Double-check your math.

            Your response MUST be a single, valid JSON object and nothing else, strictly adhering to this schema: { "weeklyPlan": [ { "day": "Monday", "title": "Session Title", "purpose": "Brief purpose of the workout", "focus": "Endurance|Speed|Technique|Recovery", "details": "Warm Up:\\n- ...\\nSubtotal: ...m\\n\\nMain Set:\\n- ...\\nSubtotal: ...m\\n\\nCool Down:\\n- ...\\nSubtotal: ...m", "totalDistance": 1234 } ] }.`;

            try {
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } };
                const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                
                const result = await response.json();
                const planData = JSON.parse(result.candidates[0].content.parts[0].text);

                if (planData.weeklyPlan) {
                    updatePlan(planData.weeklyPlan);
                    appState.activeTab = 'plan';
                    appState.currentView = 'app';
                } else { throw new Error("Invalid plan format received from AI."); }
            } catch (error) {
                console.error("Error generating plan:", error);
                appState.currentView = 'welcome';
                alert("Sorry, we couldn't generate your plan right now. Please try again.");
            } finally {
                render();
            }
        }
        
        // --- Plan Processing & Rendering ---
        
        function sortPlan(plan) {
            const dayOrder = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
            return plan.sort((a, b) => dayOrder.indexOf(a.day) - dayOrder.indexOf(b.day));
        }

        function processPlan(plan) {
            if (!Array.isArray(plan)) return [];
            const dayOrder = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
            const fullWeekPlan = dayOrder.map(day => {
                const session = plan.find(s => s.day === day);
                if (session) {
                    return { ...session, totalDistance: session.totalDistance || 0 };
                }
                return { day: day, title: "Rest Day", purpose: "Recovery", details: "Take a day off to recover and rebuild.", totalDistance: 0 };
            });
            return sortPlan(fullWeekPlan);
        }

        function renderDashboard() {
            dashboardContainer.innerHTML = '';
            const today = new Date();
            const todayStr = today.toLocaleString('en-us', { weekday: 'long' });
            let todaysWorkout = appState.plan ? appState.plan.find(session => session.day === todayStr) : null;
            
            const hasLoggedToday = appState.logs.some(log => new Date(log.date).toDateString() === today.toDateString());

            dashboardContainer.innerHTML = `<h1 class="text-2xl font-bold mb-4">Dashboard</h1>`;
            
            // Weekly Progress Card
            if (appState.plan) {
                const topRow = document.createElement('div');
                topRow.className = 'grid grid-cols-2 gap-4 mb-6';

                const weekStart = new Date();
                weekStart.setDate(weekStart.getDate() - weekStart.getDay() + (weekStart.getDay() === 0 ? -6 : 1));
                weekStart.setHours(0,0,0,0);

                const logsThisWeek = appState.logs.filter(log => new Date(log.date) >= weekStart);
                const completedCount = new Set(logsThisWeek.filter(l => l.type === 'swim').map(l => l.session.day)).size;
                const totalWorkouts = appState.plan.filter(s => s.title.toLowerCase() !== 'rest day').length;
                const progressPercent = totalWorkouts > 0 ? (completedCount / totalWorkouts) * 100 : 0;
                const totalLoggedDistance = logsThisWeek.filter(l => l.type === 'swim').reduce((sum, l) => sum + l.distance, 0);

                topRow.innerHTML = `
                    <div class="bg-white p-4 rounded-lg shadow-md flex items-center justify-center">${createProgressRing(progressPercent, 'Workouts This Week', `${completedCount}/${totalWorkouts}`)}</div>
                    <div class="bg-white p-4 rounded-lg shadow-md flex items-center justify-center">
                        <div class="text-center">
                            <p class="text-4xl font-bold">${totalLoggedDistance}</p>
                            <p class="text-sm text-gray-600 mt-2">Meters This Week</p>
                        </div>
                    </div>
                `;
                dashboardContainer.appendChild(topRow);
            }


            const card = document.createElement('div');
            card.className = 'session-card bg-white p-6 rounded-lg shadow-md border-l-4';
            
            if (hasLoggedToday) {
                card.classList.add('opacity-60');
            }

            if (todaysWorkout) {
                if (todaysWorkout.title.toLowerCase() === 'rest day') {
                    card.classList.add('border-gray-400');
                    card.innerHTML = `<h2 class="text-xl font-bold text-gray-800">Rest Day!</h2><p class="text-gray-600 mt-2">No workout scheduled for today. Tomorrow's focus: ${appState.plan[(appState.plan.indexOf(todaysWorkout) + 1) % 7].title}</p>`;
                } else {
                    card.classList.add('border-blue-500');
                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <h2 class="text-xl font-bold text-gray-800 flex items-center">${todaysWorkout.title} ${hasLoggedToday ? '<ion-icon name="checkmark-circle" class="text-green-500 ml-2"></ion-icon>' : ''}</h2>
                        </div>
                        <div id="dashboard-details" class="text-gray-600 mt-2 mb-4 hidden whitespace-pre-wrap">${todaysWorkout.details.replace(/\n/g, '<br>')}</div>
                        <button id="toggle-details-btn" class="text-blue-500 font-semibold my-2">View Details</button>
                        <button id="log-session-btn" class="w-full mt-2 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg ${hasLoggedToday ? 'bg-gray-400 hover:bg-gray-400 cursor-not-allowed' : ''}" ${hasLoggedToday ? 'disabled' : ''}>
                            ${hasLoggedToday ? 'Completed' : 'Complete & Log Session'}
                        </button>
                    `;
                    
                    setTimeout(() => { // Use timeout to ensure card is in DOM
                        document.getElementById('toggle-details-btn').addEventListener('click', (e) => {
                            const details = document.getElementById('dashboard-details');
                            details.classList.toggle('hidden');
                            e.target.textContent = details.classList.contains('hidden') ? 'View Details' : 'Hide Details';
                        });
                        if (!hasLoggedToday) {
                            document.getElementById('log-session-btn').addEventListener('click', () => openLogModal(todaysWorkout));
                        }
                    }, 0);
                }
            } else {
                 card.classList.add('border-gray-400');
                 card.innerHTML = `<h2 class="text-xl font-bold text-gray-800">No Workout Today</h2><p class="text-gray-600 mt-2">Enjoy your day!</p>`;
            }
            dashboardContainer.appendChild(card);
        }

        function createProgressRing(progressPercent, label, valueText) {
            const radius = 36;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (progressPercent / 100) * circumference;

            return `
                <div class="flex flex-col items-center justify-center text-center">
                    <div class="relative w-24 h-24">
                        <svg class="w-full h-full transform -rotate-90">
                            <circle class="text-gray-200" stroke-width="8" stroke="currentColor" fill="transparent" r="${radius}" cx="50%" cy="50%"/>
                            <circle class="text-blue-500"
                                stroke-width="8"
                                stroke-dasharray="${circumference}"
                                stroke-dashoffset="${offset}"
                                stroke-linecap="round"
                                stroke="currentColor"
                                fill="transparent"
                                r="${radius}"
                                cx="50%"
                                cy="50%"/>
                        </svg>
                        <span class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-xl font-bold">${valueText}</span>
                    </div>
                    <span class="text-xs text-gray-500 mt-2 font-semibold">${label}</span>
                </div>
            `;
        }

        function renderPlan(weeklyPlan) {
            planContainer.innerHTML = `<div class="flex justify-between items-center mb-4"><h1 class="text-2xl font-bold">Your Weekly Plan</h1><button id="adjust-plan-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full flex items-center"><ion-icon name="create-outline" class="mr-2"></ion-icon>Adjust Plan</button></div><div id="plan-sessions" class="space-y-4"></div>`;
            document.getElementById('adjust-plan-btn').addEventListener('click', () => {
                appState.activeTab = 'coach';
                render();
                if (appState.coachChatHistory.length === 0) {
                    addMessageToChat("How can I adjust your plan?", "coach");
                }
            });
            const planSessions = document.getElementById('plan-sessions');
            weeklyPlan.forEach(session => {
                const sessionCard = document.createElement('div');
                const hasLogged = appState.logs.some(log => log.type === 'swim' && log.session.title === session.title && log.session.day === session.day);
                const isRestDay = session.title.toLowerCase() === 'rest day';
                sessionCard.className = `bg-gray-100 p-4 rounded-lg shadow ${hasLogged || isRestDay ? 'opacity-60' : ''}`;
                
                const formattedDetails = (session.details || '').replace(/Warm Up:|Main Set:|Cool Down:/gi, (match) => `<strong>${match}</strong>`).replace(/\n/g, '<br>');

                sessionCard.innerHTML = `
                    <div class="flex justify-between items-center cursor-pointer" data-target="details-${session.day}">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800 flex items-center">${session.day} - ${session.title} ${hasLogged ? '<ion-icon name="checkmark-circle" class="text-green-500 ml-2"></ion-icon>' : ''}</h3>
                            <p class="text-sm text-gray-600 font-medium">${session.purpose || ''}</p>
                        </div>
                        <span class="text-2xl">${session.focus === 'Speed' ? '‚ö°Ô∏è' : session.focus === 'Endurance' ? 'ü´Å' : session.focus === 'Technique' ? 'üß†' : 'üßò'}</span>
                    </div>
                    <div id="details-${session.day}" class="mt-2 text-gray-600 hidden pt-2 border-t border-gray-200">
                        <p class="whitespace-pre-wrap">${formattedDetails}</p>
                        ${!isRestDay ? `<p class="font-bold mt-2">Total Distance: ${session.totalDistance}m</p>` : ''}
                        ${!hasLogged && !isRestDay ? `<button class="mark-complete-btn mt-4 w-full bg-white hover:bg-gray-200 border border-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg" data-session='${JSON.stringify(session)}'>Mark as Completed</button>` : ''}
                    </div>
                `;
                planSessions.appendChild(sessionCard);
                sessionCard.querySelector('[data-target]').addEventListener('click', (e) => {
                    const targetId = e.currentTarget.dataset.target;
                    document.getElementById(targetId).classList.toggle('hidden');
                });

                if (!hasLogged && !isRestDay) {
                    sessionCard.querySelector('.mark-complete-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        openLogModal(JSON.parse(e.target.dataset.session));
                    });
                }
            });
             const nextWeekBtn = document.createElement('button');
            nextWeekBtn.id = 'plan-next-week-btn';
            nextWeekBtn.className = 'w-full mt-6 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow';
            nextWeekBtn.textContent = 'Plan Next Week';
            nextWeekBtn.addEventListener('click', handlePlanNextWeek);
            planContainer.appendChild(nextWeekBtn);
        }
        
        function updatePlan(newPlan) {
            const processedPlan = processPlan(newPlan);
            appState.plan = processedPlan;
            savePlanToLocalStorage(processedPlan);
            renderPlan(processedPlan);
            renderDashboard();
        }

        function addMessageToChat(text, sender) {
            const message = { text, sender };
            appState.coachChatHistory.push(message);
            
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${sender}`;
            bubble.textContent = text;
            chatMessages.appendChild(bubble);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function handleCoachConversation(userRequest, isWeeklyReview = false, weeklyFeedback = {}) {
            if (!isWeeklyReview) {
                addMessageToChat(userRequest, "user");
            }
            coachChatInput.value = '';
            coachChatInput.disabled = true;
            coachSendBtn.disabled = true;

            const typingBubble = document.createElement('div');
            typingBubble.id = 'typing-indicator';
            typingBubble.className = 'chat-bubble coach loading-dots';
            typingBubble.innerHTML = '<span>.</span><span>.</span><span>.</span>';
            chatMessages.appendChild(typingBubble);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            const logSummary = appState.logs.slice(-7).map(l => {
                if (l.type === 'swim') {
                    return `On ${new Date(l.date).toLocaleDateString()}, user logged '${l.session.title}' (${l.distance}m) and felt '${l.effort}' (RPE). Technique: ${l.technique}. Notes: ${l.notes}`;
                } else {
                    return `On ${new Date(l.date).toLocaleDateString()}, user logged a non-swim activity: ${l.activity.type} for ${l.activity.duration} minutes. Notes: ${l.notes}`;
                }
            }).join('\n');
            const userProfile = JSON.stringify(appState.questionnaire.answers);

            const prompt = isWeeklyReview 
                ? `The user wants to plan their next week. Based on their original profile, their previous week's plan, and their log history, generate a new, progressed 1-week plan and a brief report.
                    User Profile: ${userProfile}
                    Previous Week's Plan: ${JSON.stringify(appState.plan)}
                    Previous Week's Logs: \n${logSummary}\n
                    User's new feedback for the week: Overall load felt '${weeklyFeedback.load}'. Additional notes: '${weeklyFeedback.notes}'.
                    CRITICAL INSTRUCTION: Analyze all logs and feedback. If they reported sessions were 'Hard' or mentioned difficulties (like 'sore shoulder'), you MUST reduce the intensity or volume of the next week's plan, especially for workouts immediately following the difficult one. If they reported 'Easy' or 'Just Right', you should slightly increase the challenge.
                    Your response must be in the 'newPlan' field, and you must also provide a short 'answer' field summarizing their week and explaining the logic for the new plan.`
                : `A user is asking a question or requesting a plan adjustment.
                    Their current plan is: ${JSON.stringify(appState.plan)}
                    Their recent log history is: \n${logSummary}\n
                    Their user request is: "${userRequest}"
                    
                    Analyze the user's request. 
                    - If the user is asking to **change, modify, adjust, add, or remove** sessions, generate a new plan and respond in the 'newPlan' field. Also provide a brief confirmation in the 'answer' field.
                    - If the user is asking a **general question, for advice, or commenting on their performance**, provide a conversational answer in the 'answer' field and leave 'newPlan' as null.
                `;
            
            const finalPrompt = `${prompt} Your response MUST be a single, valid JSON object and nothing else, strictly adhering to this schema: { "newPlan": [ { "day": "Monday", "title": "Session Title", "purpose": "Brief purpose...", "details": "..." } ] | null, "answer": "Your conversational response here." | null } Only populate 'newPlan' if a new plan is generated.`;

            try {
                const payload = { contents: [{ role: "user", parts: [{ text: finalPrompt }] }], generationConfig: { responseMimeType: "application/json" } };
                const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                
                const result = await response.json();
                const coachResponse = JSON.parse(result.candidates[0].content.parts[0].text);

                if (coachResponse.newPlan) {
                    updatePlan(coachResponse.newPlan);
                    addMessageToChat(coachResponse.answer || "I've updated your plan. Take a look in the 'Plan' tab!", "coach");
                } else if (coachResponse.answer) {
                    addMessageToChat(coachResponse.answer, "coach");
                } else {
                    throw new Error("Invalid response format from AI.");
                }

            } catch(error) {
                 console.error("Error in coach conversation:", error);
                 addMessageToChat("Sorry, I had trouble understanding that. Could you try rephrasing?", "coach");
            } finally {
                document.getElementById('typing-indicator')?.remove();
                coachChatInput.disabled = false;
                coachSendBtn.disabled = false;
                coachChatInput.focus();
            }
        }
        
        function openLogModal(session) {
            logSessionModal.dataset.session = JSON.stringify(session);
            document.getElementById('log-session-details').innerHTML = `<p class="text-sm text-gray-600">Logging for: <strong>${session.title}</strong></p>`;
            document.getElementById('log-distance').value = session.totalDistance;
            logSessionModal.classList.remove('hidden');
            logSessionModal.classList.add('flex');
        }

        function closeLogModal() {
            logSessionModal.classList.add('hidden');
            logSessionModal.classList.remove('flex');
            document.getElementById('log-notes').value = '';
            document.querySelectorAll('.log-effort-btn.selected, .log-technique-btn.selected').forEach(b => b.classList.remove('selected', 'bg-blue-200'));
        }
        
        function handleSaveLog() {
            const session = JSON.parse(logSessionModal.dataset.session);
            const distance = parseInt(document.getElementById('log-distance').value, 10);
            const time = document.getElementById('log-time').value;
            const effort = document.querySelector('.log-effort-btn.selected')?.dataset.effort || 'Not specified';
            const technique = document.querySelector('.log-technique-btn.selected')?.dataset.technique || 'Not specified';
            const notes = document.getElementById('log-notes').value;
            
            const logEntry = {
                type: 'swim',
                date: new Date().toISOString(),
                session: session,
                distance: isNaN(distance) ? session.totalDistance : distance,
                time: time,
                effort: effort,
                technique: technique,
                notes: notes
            };
            
            appState.logs.push(logEntry);
            saveLogsToLocalStorage();
            renderLogbook();
            renderDashboard(); // Re-render dashboard to show logged state
            renderPlan(appState.plan); // Re-render plan to show completed state
            closeLogModal();
        }
        
        function renderLogbook() {
            logbookContainer.innerHTML = `<div class="flex justify-between items-center mb-4"><h1 class="text-2xl font-bold">Logbook</h1><button id="edit-view-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full flex items-center"><ion-icon name="options-outline" class="mr-2"></ion-icon>Edit View</button></div>`;
            
            const viewOptions = document.createElement('div');
            viewOptions.id = 'view-options';
            viewOptions.className = 'hidden bg-gray-50 p-4 rounded-lg mb-4 space-y-2';
            viewOptions.innerHTML = `
                <label class="flex items-center"><input type="checkbox" data-view="showDistance" class="mr-2" ${appState.logbookViewPrefs.showDistance ? 'checked' : ''}> Weekly Distance Chart</label>
                <label class="flex items-center"><input type="checkbox" data-view="showEffort" class="mr-2" ${appState.logbookViewPrefs.showEffort ? 'checked' : ''}> Effort (RPE) Chart</label>
                <label class="flex items-center"><input type="checkbox" data-view="showTechnique" class="mr-2" ${appState.logbookViewPrefs.showTechnique ? 'checked' : ''}> Technique Chart</label>
                <label class="flex items-center"><input type="checkbox" data-view="showHistory" class="mr-2" ${appState.logbookViewPrefs.showHistory ? 'checked' : ''}> Detailed History</label>
            `;
            logbookContainer.appendChild(viewOptions);

            document.getElementById('edit-view-btn').addEventListener('click', () => {
                viewOptions.classList.toggle('hidden');
            });

            viewOptions.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    appState.logbookViewPrefs[e.target.dataset.view] = e.target.checked;
                    saveLogbookViewPrefs();
                    renderLogbook();
                });
            });

            const chartGrid = document.createElement('div');
            chartGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 mb-6';
            chartGrid.innerHTML = `
                <div id="distance-chart-container" class="${appState.logbookViewPrefs.showDistance ? '' : 'hidden'}"><canvas id="logbook-chart"></canvas></div>
                <div id="effort-chart-container" class="${appState.logbookViewPrefs.showEffort ? '' : 'hidden'}"><canvas id="effort-chart"></canvas></div>
                <div id="technique-chart-container" class="${appState.logbookViewPrefs.showTechnique ? '' : 'hidden'}"><canvas id="technique-chart"></canvas></div>
            `;
            logbookContainer.appendChild(chartGrid);

            const historyContainer = document.createElement('div');
            historyContainer.id = 'history-container';
            historyContainer.className = `${appState.logbookViewPrefs.showHistory ? '' : 'hidden'}`;
            historyContainer.innerHTML = `<button id="history-toggle" class="font-semibold text-blue-600 mb-2 w-full text-left flex justify-between items-center"><span>Detailed History</span><ion-icon name="chevron-down-outline"></ion-icon></button><div id="log-list" class="space-y-4 hidden pt-2 border-t"></div>`;
            logbookContainer.appendChild(historyContainer);

            document.getElementById('history-toggle').addEventListener('click', (e) => {
                const logList = document.getElementById('log-list');
                logList.classList.toggle('hidden');
                const icon = e.currentTarget.querySelector('ion-icon');
                icon.name = logList.classList.contains('hidden') ? 'chevron-down-outline' : 'chevron-up-outline';
            });


            if (appState.logs.length === 0) {
                logbookContainer.innerHTML += `<p class="text-gray-600">Your completed sessions will appear here.</p>`;
                renderWeeklyChart([]);
                renderEffortChart([]);
                renderTechniqueChart([]);
                return;
            }
            
            const swimLogs = appState.logs.filter(l => l.type === 'swim');
            const weeklyData = swimLogs.reduce((acc, log) => {
                const date = new Date(log.date);
                const weekStart = new Date(date.setDate(date.getDate() - date.getDay() + (date.getDay() === 0 ? -6 : 1)));
                const weekKey = weekStart.toLocaleDateString('en-CA');
                if (!acc[weekKey]) {
                    acc[weekKey] = 0;
                }
                acc[weekKey] += log.distance;
                return acc;
            }, {});

            const chartData = Object.entries(weeklyData).map(([date, distance]) => ({ date, distance })).sort((a,b) => new Date(a.date) - new Date(b.date));
            renderWeeklyChart(chartData);

            const effortData = swimLogs.reduce((acc, log) => {
                acc[log.effort] = (acc[log.effort] || 0) + 1;
                return acc;
            }, {});
            renderEffortChart(effortData);
            
            const techniqueData = swimLogs.reduce((acc, log) => {
                acc[log.technique] = (acc[log.technique] || 0) + 1;
                return acc;
            }, {});
            renderTechniqueChart(techniqueData);

            const logListEl = document.getElementById('log-list');
            [...appState.logs].reverse().forEach(log => {
                const logCard = document.createElement('div');
                logCard.className = 'bg-gray-50 p-4 rounded-lg cursor-pointer';
                
                if(log.type === 'swim') {
                    const formattedDetails = (log.session.details || '').replace(/Warm Up:|Main Set:|Cool Down:/gi, (match) => `<br><strong>${match}</strong>`).replace(/\n/g, '<br>');
                    logCard.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold">${new Date(log.date).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}</p>
                                <p class="text-sm text-gray-700 mt-1"><strong>Workout:</strong> ${log.session.title}</p>
                                <p class="text-sm text-gray-700"><strong>Effort (RPE):</strong> ${log.effort}</p>
                                <p class="text-sm text-gray-700"><strong>Technique:</strong> ${log.technique}</p>
                            </div>
                            <div class="text-sm font-semibold text-blue-600">${log.distance}m</div>
                        </div>
                        <div class="log-details mt-2 text-gray-600 hidden pt-2 border-t border-gray-200">
                            <p class="whitespace-pre-wrap">${formattedDetails}</p>
                            ${log.notes ? `<p class="text-sm text-gray-700 mt-2 p-2 bg-white rounded"><strong>Notes:</strong> ${log.notes}</p>` : ''}
                        </div>
                    `;
                }

                logCard.addEventListener('click', () => {
                    logCard.querySelector('.log-details').classList.toggle('hidden');
                });
                logListEl.appendChild(logCard);
            });
        }

        function renderWeeklyChart(data) {
            const container = document.getElementById('distance-chart-container');
            if (!container || container.classList.contains('hidden')) return;
            const ctx = document.getElementById('logbook-chart').getContext('2d');
            if (appState.weeklyChart) {
                appState.weeklyChart.destroy();
            }
            appState.weeklyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => `Week of ${new Date(d.date).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}`),
                    datasets: [{
                        label: 'Total Distance (m)',
                        data: data.map(d => d.distance),
                        backgroundColor: 'rgba(59, 130, 246, 0.5)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false }, title: { display: true, text: 'Weekly Distance' } }
                }
            });
        }
        
        function renderEffortChart(data) {
            const container = document.getElementById('effort-chart-container');
            if (!container || container.classList.contains('hidden')) return;
            const ctx = document.getElementById('effort-chart').getContext('2d');
            if (appState.effortChart) {
                appState.effortChart.destroy();
            }
            appState.effortChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['1', '2', '3', '4', '5'],
                    datasets: [{
                        label: 'Effort (RPE)',
                        data: [data['1'] || 0, data['2'] || 0, data['3'] || 0, data['4'] || 0, data['5'] || 0],
                        backgroundColor: 'rgba(255, 159, 64, 0.5)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1
                    }]
                },
                 options: {
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
                    plugins: { legend: { display: false }, title: { display: true, text: 'Effort (RPE)' } }
                }
            });
        }

        function renderTechniqueChart(data) {
            const container = document.getElementById('technique-chart-container');
            if (!container || container.classList.contains('hidden')) return;
            const ctx = document.getElementById('technique-chart').getContext('2d');
            if (appState.techniqueChart) {
                appState.techniqueChart.destroy();
            }
            appState.techniqueChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Smooth', 'Okay', 'Sloppy'],
                    datasets: [{
                        label: 'Technique',
                        data: [data['Smooth'] || 0, data['Okay'] || 0, data['Sloppy'] || 0],
                        backgroundColor: ['rgba(75, 192, 192, 0.5)', 'rgba(255, 205, 86, 0.5)', 'rgba(255, 99, 132, 0.5)'],
                        borderColor: ['rgba(75, 192, 192, 1)', 'rgba(255, 205, 86, 1)', 'rgba(255, 99, 132, 1)'],
                        borderWidth: 1
                    }]
                },
                 options: {
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
                    plugins: { legend: { display: false }, title: { display: true, text: 'Technique' } }
                }
            });
        }

        // --- Local Storage & Event Handlers ---
        function savePlanToLocalStorage(plan) { try { localStorage.setItem('swimCoachPlan', JSON.stringify(plan)); } catch (e) { console.error(e); } }
        function loadPlanFromLocalStorage() { try { return JSON.parse(localStorage.getItem('swimCoachPlan')); } catch (e) { return null; } }
        function saveLogsToLocalStorage() { try { localStorage.setItem('swimCoachLogs', JSON.stringify(appState.logs)); } catch (e) { console.error(e); } }
        function loadLogsFromLocalStorage() { try { return JSON.parse(localStorage.getItem('swimCoachLogs')) || []; } catch (e) { return []; } }
        function saveLogbookViewPrefs() { try { localStorage.setItem('swimCoachLogbookViewPrefs', JSON.stringify(appState.logbookViewPrefs)); } catch (e) { console.error(e); } }
        function loadLogbookViewPrefs() { try { return JSON.parse(localStorage.getItem('swimCoachLogbookViewPrefs')) || appState.logbookViewPrefs; } catch (e) { return appState.logbookViewPrefs; } }
        function handleNavClick(e) { e.preventDefault(); appState.activeTab = e.currentTarget.dataset.tab; render(); }
        function handleCreatePlanClick() { appState.currentView = 'questionnaire'; render(); }
        
        function handleOptionSelect(key, value) {
            appState.questionnaire.answers[key] = value;
            
            const visibleSteps = getVisibleSteps();
            const currentStepObject = appState.questionnaire.steps.find(s => s.key === key);
            let currentVisibleStepIndex = visibleSteps.indexOf(currentStepObject);

            if (currentVisibleStepIndex < visibleSteps.length - 1) {
                const nextVisibleStep = visibleSteps[currentVisibleStepIndex + 1];
                appState.questionnaire.currentStep = appState.questionnaire.steps.indexOf(nextVisibleStep);
            } else {
                appState.questionnaire.currentStep = appState.questionnaire.steps.length;
            }
            renderQuestionnaireStep();
        }

        function handleQuestionnaireBack() {
            const visibleSteps = getVisibleSteps();
            const currentStepObject = appState.questionnaire.steps[appState.questionnaire.currentStep] || visibleSteps[visibleSteps.length - 1];
            let currentVisibleStepIndex = visibleSteps.indexOf(currentStepObject);
            
            if (currentVisibleStepIndex === -1) { // We are at the 'Generate Plan' or summary screen
                currentVisibleStepIndex = visibleSteps.length;
            }

            if (currentVisibleStepIndex > 0) {
                const prevVisibleStep = visibleSteps[currentVisibleStepIndex - 1];
                appState.questionnaire.currentStep = appState.questionnaire.steps.indexOf(prevVisibleStep);
                renderQuestionnaireStep();
            }
        }
        function handleSendCoachMessage() { const message = coachChatInput.value.trim(); if (message) handleCoachConversation(message, false); }
        function handlePlanNextWeek() {
            openWeeklyReviewModal();
        }

        function openWeeklyReviewModal() {
            const today = new Date();
            const weekStart = new Date(today);
            weekStart.setDate(weekStart.getDate() - weekStart.getDay() + (weekStart.getDay() === 0 ? -6 : 1));
            weekStart.setHours(0,0,0,0);
            const logsThisWeek = appState.logs.filter(log => new Date(log.date) >= weekStart);
            const summaryEl = document.getElementById('weekly-review-summary');
            summaryEl.innerHTML = `This past week, you completed <strong>${logsThisWeek.length}</strong> workouts. Let's plan the next one!`;
            weeklyReviewModal.classList.remove('hidden');
            weeklyReviewModal.classList.add('flex');
        }

        function closeWeeklyReviewModal() {
            weeklyReviewModal.classList.add('hidden');
            weeklyReviewModal.classList.remove('flex');
            document.getElementById('review-notes').value = '';
            document.querySelectorAll('.review-load-btn.selected').forEach(b => b.classList.remove('selected', 'bg-blue-200'));
        }

        function handleWeeklyReviewSubmit() {
            const load = document.querySelector('.review-load-btn.selected')?.dataset.load || 'Not specified';
            const notes = document.getElementById('review-notes').value;
            closeWeeklyReviewModal();
            appState.activeTab = 'coach';
            render();
            addMessageToChat(`Weekly Review:\nLoad: ${load}\nNotes: ${notes}`, "user");
            handleCoachConversation("Plan my next week based on my review.", true, { load, notes });
        }

        // --- App Initialization ---
        function initializeApp() {
            appState.plan = loadPlanFromLocalStorage();
            appState.logs = loadLogsFromLocalStorage();
            appState.logbookViewPrefs = loadLogbookViewPrefs();
            if (appState.plan) {
                updatePlan(appState.plan); 
                renderLogbook();
                appState.currentView = 'app';
                appState.activeTab = 'dashboard';
            } else {
                appState.currentView = 'welcome';
            }
            render();
        }

        createPlanBtn.addEventListener('click', handleCreatePlanClick);
        navItems.forEach(item => item.addEventListener('click', handleNavClick));
        coachSendBtn.addEventListener('click', handleSendCoachMessage);
        coachChatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSendCoachMessage(); });
        cancelLogBtn.addEventListener('click', closeLogModal);
        saveLogBtn.addEventListener('click', handleSaveLog);
        cancelReviewBtn.addEventListener('click', closeWeeklyReviewModal);
        submitReviewBtn.addEventListener('click', handleWeeklyReviewSubmit);
        
        logSessionModal.addEventListener('click', (e) => {
            if (e.target.classList.contains('log-effort-btn')) {
                document.querySelectorAll('.log-effort-btn').forEach(b => b.classList.remove('selected', 'bg-blue-200'));
                e.target.classList.add('selected', 'bg-blue-200');
            }
            if (e.target.classList.contains('log-technique-btn')) {
                document.querySelectorAll('.log-technique-btn').forEach(b => b.classList.remove('selected', 'bg-blue-200'));
                e.target.classList.add('selected', 'bg-blue-200');
            }
        });

        weeklyReviewModal.addEventListener('click', (e) => {
             if (e.target.classList.contains('review-load-btn')) {
                document.querySelectorAll('.review-load-btn').forEach(b => b.classList.remove('selected', 'bg-blue-200'));
                e.target.classList.add('selected', 'bg-blue-200');
            }
        });
        
        initializeApp();

    </script>
</body>
</html>
